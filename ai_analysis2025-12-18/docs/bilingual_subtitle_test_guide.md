# 双语字幕生成功能测试指南

## 测试方法概述

双语字幕生成功能可以通过以下三种方式测试：

1. **自动化单元测试**：运行 `tests/test_bilingual_subtitle.py`
2. **GUI 实际使用测试**：在 GUI 中处理真实视频
3. **CLI 实际使用测试**：通过命令行处理视频

---

## 方法一：自动化单元测试（推荐）

### 运行测试脚本

```bash
# 在项目根目录下运行
python tests/test_bilingual_subtitle.py
```

### 测试内容

测试脚本包含三个测试用例：

1. **`test_srt_parsing()`**：测试 SRT 字幕解析功能
   - 验证能否正确解析 SRT 格式
   - 验证能否提取序号、时间码、文本

2. **`test_bilingual_subtitle_generation()`**：测试双语字幕生成
   - 验证 `write_bilingual_subtitle()` 方法
   - 验证文件命名格式：`bilingual.<source>-<target>.srt`
   - 验证内容格式：`源语言 / 目标语言`

3. **`test_bilingual_mode_in_write_all()`**：测试 `write_all` 中的双语模式
   - 验证 `bilingual_mode="none"` 时不生成双语字幕
   - 验证 `bilingual_mode="source+target"` 时生成双语字幕

### 预期输出

```
============================================================
双语字幕生成功能测试套件
============================================================

============================================================
测试：SRT 解析功能
============================================================
   ✓ SRT 解析功能正常
   ✓ 解析出 2 个字幕条目
============================================================
✓ SRT 解析功能测试通过！
============================================================

============================================================
测试：双语字幕生成功能
============================================================
1. 测试 write_bilingual_subtitle 方法...
   ✓ 双语字幕文件已创建: bilingual.en-zh-CN.srt
2. 验证双语字幕内容...
   双语字幕内容预览：
   ...
   ✓ 双语字幕格式正确（包含源语言 / 目标语言）
   ✓ 文件命名正确: bilingual.en-zh-CN.srt
============================================================
✓ 双语字幕生成功能测试通过！
============================================================

============================================================
测试：write_all 方法中的双语模式
============================================================
1. 测试 bilingual_mode = 'none'...
   ✓ bilingual_mode='none' 时未生成双语字幕（正确）
2. 测试 bilingual_mode = 'source+target'...
   ✓ 生成了 1 个双语字幕文件
   ✓ 双语字幕内容正确: bilingual.en-zh-CN.srt
============================================================
✓ write_all 双语模式测试通过！
============================================================

============================================================
✓ 所有测试通过！
============================================================
```

---

## 方法二：GUI 实际使用测试

### 测试步骤

1. **启动 GUI**
   ```bash
   python ui/main.py
   ```

2. **配置双语模式**
   - 进入"频道模式"页面
   - 在"语言配置"区域，找到"双语字幕模式"下拉框
   - 选择"原文+目标语言"（对应 `source+target`）

3. **配置字幕目标语言**
   - 在"字幕目标语言"文本框中输入目标语言，例如：`zh-CN`（每行一个）

4. **保存语言设置**
   - 点击"保存语言设置"按钮

5. **处理视频**
   - 输入一个 YouTube 频道 URL 或视频 URL
   - 点击"开始处理"按钮
   - 等待处理完成

6. **验证输出**
   - 打开输出目录（默认：`out/`）
   - 进入视频对应的文件夹
   - 检查是否存在 `bilingual.<source>-<target>.srt` 文件
   - 打开文件，验证内容格式为：`源语言 / 目标语言`

### 验证要点

- ✅ 双语字幕文件命名格式正确：`bilingual.en-zh-CN.srt`
- ✅ 文件内容格式正确：每行字幕为 `源语言 / 目标语言`
- ✅ 时间轴对齐正确：源语言和目标语言的时间码一致
- ✅ 当 `bilingual_mode="none"` 时，不生成双语字幕文件

---

## 方法三：CLI 实际使用测试

### 测试步骤

1. **配置双语模式**

   编辑 `config.json` 或使用 CLI 参数：

   ```json
   {
     "language": {
       "bilingual_mode": "source+target",
       "subtitle_target_languages": ["zh-CN"]
     }
   }
   ```

2. **运行 CLI 处理视频**

   ```bash
   # 处理单个视频
   python cli.py process --url "https://www.youtube.com/watch?v=VIDEO_ID"
   
   # 或处理频道
   python cli.py process --channel "https://www.youtube.com/@CHANNEL_NAME"
   ```

3. **验证输出**

   检查输出目录中的双语字幕文件：

   ```bash
   # 查看输出目录结构
   ls -R out/
   
   # 查看双语字幕文件
   cat out/VIDEO_ID/bilingual.en-zh-CN.srt
   ```

---

## 测试检查清单

### 功能测试

- [ ] SRT 解析功能正常（单元测试通过）
- [ ] 双语字幕生成功能正常（单元测试通过）
- [ ] `write_all` 双语模式逻辑正确（单元测试通过）
- [ ] GUI 中双语模式配置生效
- [ ] CLI 中双语模式配置生效
- [ ] 双语字幕文件命名正确
- [ ] 双语字幕内容格式正确（`源语言 / 目标语言`）
- [ ] 时间轴对齐正确

### 边界情况测试

- [ ] `bilingual_mode="none"` 时不生成双语字幕
- [ ] `bilingual_mode="source+target"` 时生成双语字幕
- [ ] 源语言和目标语言时间轴不完全一致时的处理
- [ ] 源语言或目标语言字幕缺失时的处理

### 实际使用测试

- [ ] 处理真实 YouTube 视频，验证双语字幕生成
- [ ] 验证双语字幕文件可以在视频播放器中正常显示
- [ ] 验证多目标语言时，每个目标语言都生成对应的双语字幕

---

## 常见问题排查

### 问题 1：测试脚本运行失败

**可能原因**：
- Python 路径问题
- 模块导入失败

**解决方法**：
```bash
# 确保在项目根目录下运行
cd C:\Users\21027\Desktop\gpt_tool\yt-subtitle-v2
python tests/test_bilingual_subtitle.py
```

### 问题 2：GUI 中未生成双语字幕

**可能原因**：
- 双语模式未设置为 `source+target`
- 语言配置未保存
- 源语言字幕或目标语言字幕缺失

**解决方法**：
1. 检查"语言配置"中的"双语字幕模式"是否选择为"原文+目标语言"
2. 点击"保存语言设置"按钮
3. 确保视频有源语言字幕，且已成功翻译为目标语言

### 问题 3：双语字幕内容格式错误

**可能原因**：
- SRT 解析失败
- 时间轴对齐失败

**解决方法**：
1. 检查源语言和目标语言字幕文件是否格式正确
2. 检查时间轴是否对齐
3. 查看日志文件中的错误信息

---

## 相关文件

- **测试脚本**：`tests/test_bilingual_subtitle.py`
- **核心实现**：`core/output.py`（`write_bilingual_subtitle`, `_parse_srt`, `_merge_srt_entries`）
- **配置模型**：`core/language.py`（`LanguageConfig.bilingual_mode`）
- **Pipeline 集成**：`core/pipeline.py`（通过 `output_writer.write_all()` 调用）

---

## 测试报告模板

测试完成后，可以按以下格式记录测试结果：

```markdown
## 测试日期：2025-12-09

### 测试环境
- Python 版本：3.x.x
- 操作系统：Windows 10
- 测试方法：自动化单元测试 + GUI 实际使用

### 测试结果
- [x] SRT 解析功能：通过
- [x] 双语字幕生成功能：通过
- [x] write_all 双语模式：通过
- [x] GUI 双语模式配置：通过
- [x] 实际视频处理：通过

### 发现的问题
无

### 备注
所有测试通过，功能正常。
```

