# AI 供应商健康自检指南

## 概述

`ai-smoke-test` 命令用于检查所有配置的 AI 供应商是否可用。它会遍历当前配置中启用的所有 LLMClient，分别发起一个极小请求，验证 API Key、代理、网络是否可用，并输出详细的健康报告。

## 使用方式

### 基本用法

```bash
python -m cli.main ai-smoke-test
```

或者：

```bash
python cli/main.py ai-smoke-test
```

### 功能说明

命令会：

1. **收集所有 AI 配置**：
   - 从 `config.json` 中读取 `translation_ai` 和 `summary_ai`
   - 从 `ai_profiles.json` 中读取所有启用的 Profile
   - 优先使用 Profile 配置，如果没有则使用默认配置

2. **测试每个配置**：
   - 尝试创建 LLM 客户端
   - 发送一个极轻量的测试请求（"Hi"，最多 5 tokens）
   - 记录响应时间和测试响应

3. **生成健康报告**：
   - 显示每个配置的健康状态
   - 提供详细的错误信息（如果有）
   - 统计健康/不健康/已禁用/未配置的数量

## 报告解读

### 健康状态

- **✅ 健康**：配置可用，测试请求成功
- **❌ 不健康**：配置有问题（API Key 错误、网络问题等）
- **⚠️ 已禁用**：配置存在但已禁用
- **⚪ 未配置**：配置不存在或未启用

### 报告示例

```
================================================================================
AI 供应商健康报告
================================================================================

总计: 2 个配置
  ✅ 健康: 1
  ❌ 不健康: 1
  ⚠️  已禁用: 0
  ⚪ 未配置: 0

--------------------------------------------------------------------------------

【翻译 AI (默认配置)】
  提供商: google_translate
  模型: google_translate_free
  状态: ✅ 健康
  响应时间: 0.87 秒
  测试响应: 你好

【摘要 AI (默认配置)】
  提供商: openai
  模型: gpt-4o-mini
  Base URL: https://api.openai.com/v1
  状态: ❌ 不健康
  错误: 客户端创建失败: 未找到 OpenAI API Key（配置: ）
================================================================================
```

## 常见错误及解决方案

### 1. API Key 未配置

**错误信息**：
```
错误: 客户端创建失败: 未找到 OpenAI API Key（配置: ）
```

**解决方案**：
- 检查 `config.json` 中的 `api_keys` 配置
- 确保环境变量已设置（如果使用 `env:VAR_NAME` 格式）
- 检查 API Key 是否正确

### 2. 认证失败

**错误信息**：
```
错误: 认证失败: Invalid API Key（请检查 API Key）
```

**解决方案**：
- 验证 API Key 是否有效
- 检查 API Key 是否过期
- 确认 API Key 对应的服务是否正确

### 3. 网络错误

**错误信息**：
```
错误: 网络错误: Connection refused（请检查网络连接和代理设置）
```

**解决方案**：
- 检查网络连接
- 验证代理设置（如果使用代理）
- 检查防火墙设置
- 对于本地模型，确保服务正在运行

### 4. 超时

**错误信息**：
```
错误: 超时: Request timeout（请检查服务是否可用）
```

**解决方案**：
- 检查服务是否正常运行
- 增加 `timeout_seconds` 配置
- 检查网络延迟
- 对于本地模型，检查资源使用情况

### 5. 频率限制

**错误信息**：
```
错误: 频率限制: Rate limit exceeded
```

**解决方案**：
- 等待一段时间后重试
- 检查 API 使用配额
- 降低并发数（`max_concurrency`）

## 使用场景

### 1. 首次配置后验证

在首次配置 AI 供应商后，运行健康检查确保配置正确：

```bash
python -m cli.main ai-smoke-test
```

### 2. 重大改版后验证

在更新配置或改版后，验证所有配置仍然可用：

```bash
python -m cli.main ai-smoke-test
```

### 3. 故障排查

当遇到 AI 调用问题时，运行健康检查定位问题：

```bash
python -m cli.main ai-smoke-test
```

### 4. 定期检查

建议定期运行健康检查，确保所有配置正常：

```bash
# 可以添加到 cron 或定时任务
python -m cli.main ai-smoke-test
```

## 退出码

- **0**：所有配置健康（或未配置）
- **1**：至少有一个配置不健康

可以在脚本中使用退出码：

```bash
python -m cli.main ai-smoke-test
if [ $? -eq 0 ]; then
    echo "所有配置健康"
else
    echo "有配置不健康，请检查"
fi
```

## 支持的配置来源

### 1. 默认配置（config.json）

- `translation_ai`：翻译 AI 配置
- `summary_ai`：摘要 AI 配置

### 2. Profile 配置（ai_profiles.json）

- 所有启用的 Profile
- 任务映射中使用的 Profile
- 未使用的 Profile（也会被检测）

### 3. 优先级

1. 如果任务映射中配置了 Profile，使用 Profile
2. 否则使用默认配置
3. 如果都未配置，标记为"未配置"

## 测试请求详情

健康检查使用的测试请求：

- **提示**：`"Hi"`（极简）
- **最大输出**：5 tokens
- **温度**：0.0（最低）
- **目的**：最小化资源消耗，快速验证可用性

## 注意事项

1. **API 费用**：测试请求会消耗少量 API 调用，但成本极低
2. **本地模型**：如果使用本地模型（如 Ollama），确保服务正在运行
3. **网络**：需要网络连接才能测试云端 API
4. **超时**：某些配置可能响应较慢，请耐心等待

## 相关文档

- `docs/ai_profile_design.md`: AI Profile 配置设计
- `docs/local_model_warmup.md`: 本地模型预热功能
- `docs/AI_PROVIDER_EXTENSION.md`: AI 提供商扩展规范

