# YouTube 字幕工具 v3.2 统一施工规范与验收清单

> **版本**: v1.0 (合并版)  
> **日期**: 2025-12-19  
> **基于**: Claude/GPT/Grok 三方设计 + Gemini 代码分析  
> **适用范围**: v3.2 功能增强 + 代码精简重构

---

## 📋 任务进度总览

### 快速查看

| 任务ID | 优先级 | 任务名称 | 时间 | 状态 | 验收关键点 |
|--------|--------|----------|------|------|-----------|
| P1-1 | 🔴 P0 | i18n 架构统一 | 6-8h | ✅ 完成 | 语言切换生效、fallback 不崩溃 |
| P1-2 | 🔴 P0 | logger 入口改造 | (含上) | ✅ 完成 | DEBUG 英文、INFO+ 本地化 |
| P2-1 | 🔴 P0 | 语言工具提取 | 1d | ✅ 完成 | `lang_matches()` 只定义一次 |
| P2-2 | 🔴 P0 | 字幕智能合并 | 2d | ✅ 完成 | 翻译质量对比明显提升 |
| P3-1 | 🔴 P0 | 断点续传状态机 | 1.5d | ✅ 完成 | kill 后 resume 能继续 |
| P3-2 | 🔴 P0 | Pipeline 拆分 | 1.5d | ✅ 完成 | 巨型函数拆为 5 阶段 |
| P3-3 | 🟡 P1 | chunk 级恢复 | 1d | ✅ 完成 | 翻译中途失败可恢复 |
| P4-1 | 🟡 P1 | 时间预估 ETA | 0.5d | ✅ 完成 | ETA 显示合理 |
| P4-2 | 🟢 P2 | YouTube 章节 | (含上) | ✅ 完成 | 有章节时输出章节 Markdown |
| P5-1 | 🟢 P2 | UI 组件提取 | 1-2d | ✅ 完成 | 减少 ~350 行重复代码 |

### 进度统计

| 优先级 | 总数 | 完成 | 进行中 | 待开始 |
|--------|------|------|--------|--------|
| 🔴 P0 | 6 | 6 | 0 | 0 |
| 🟡 P1 | 2 | 2 | 0 | 0 |
| 🟢 P2 | 2 | 2 | 0 | 0 |

### 依赖关系

```
P1-1 (i18n) ────► P1-2 (logger) ────► P2-1 (语言工具) ────► P2-2 (字幕合并)
                                                              │
                                                              ▼
                              P3-1 (状态机) ◄──── P3-2 (Pipeline) ────► P3-3 (chunk)
                                                              │
                                                              ▼
                                               P4-1 (ETA) ────► P4-2 (章节)
                                                              │
                                                              ▼
                                                        P5-1 (UI 可选)
```

---

## 一、总体策略

### 1.1 核心原则

| 等级 | 规则 |
|------|------|
| **MUST** | 新代码零硬编码，所有用户可见字符串走 `t()`/`tn()` |
| **MUST** | 不破坏现有功能，变更需通过现有测试 |
| **MUST** | 每个 Phase 可独立回滚 |
| **SHOULD** | 每个 Phase 拆成多个小 PR：壳子 → 接入 → 测试 |

### 1.2 明确不做

- ❌ API 成本监控
- ❌ 自动主题分章
- ❌ 两轮翻译润色
- ❌ 按字符比例拆时间轴

---

## 二、时间预估（基于代码分析调整）

| Phase | 内容 | 原预估 | 调整后 | 调整原因 |
|-------|------|--------|--------|---------|
| **1** | i18n 架构统一 | 4-6h | **6-8h** | `logger.py` 1013行，改入口需仔细测试 |
| **2** | 字幕智能合并 + 语言工具提取 | 1-2d | **2-3d** | 合并 `lang_matches()` 提取，涉及 3 个文件 |
| **3** | 断点续传 + Pipeline 拆分 | 1.5-2d | **3-4d** | `single_video.py` 376行巨型函数拆分 |
| **4** | 时间预估 + 章节 | 0.5d | **0.5d** | 无调整 |
| **整合** | UI 组件提取（可选） | - | **1-2d** | 如需精简 UI 页面 |
| **总计** | | 4-6d | **7-10d** | |

---

## 三、整合后的 Phase 计划

### Phase 1: i18n 架构统一 (6-8 小时)

**范围**:
- 新建 `core/i18n/`（统一入口 + provider 抽象）
- 改造 `core/logger.py` 入口（最小改动，不拆分）
- UI 层改为薄封装

**交付物**:
```
core/i18n/
  __init__.py        ← t(), tn(), set_language()
  provider.py        ← I18nProvider Protocol
  json_provider.py   ← JSON 加载器
  locales/
    zh_CN.json       ← 移动自 ui/i18n/
    en_US.json
```

**DoD (完成定义)**:
- [ ] 默认英文可运行，中文不丢 key
- [ ] 新日志符合：DEBUG 英文，INFO+ 本地化
- [ ] CI 门禁：key 一致性 + 硬编码检测

**验收用例**:
1. GUI/CLI 切换语言，日志和界面跟随变化
2. 删除某 key，应 fallback 不崩溃

---

### Phase 2: 字幕智能合并 + 语言工具提取 (2-3 天)

**范围**:
- 新建 `core/language_utils.py`（提取 `lang_matches()` 等公共函数）
- 新建 `core/subtitle/merger.py`（句子合并 + 块时间范围输出）
- 改造 `core/translator.py` 和 `core/downloader.py` 使用公共模块

**整合精简任务**:
| 原文件 | 精简内容 | 预计减少 |
|--------|---------|---------|
| `downloader.py` | 删除重复 `lang_matches()` (2处) | ~50 行 |
| `translator.py` | 删除重复 `lang_matches()` | ~30 行 |

**交付物**:
```
core/
  language_utils.py      ← 新建：lang_matches(), COMMON_LANGUAGES 等
  subtitle/
    __init__.py
    merger.py            ← 新建：句子合并逻辑
```

**合并规则 (MVP 参数)**:
| 规则 | 阈值 |
|------|------|
| 标点断句 | 。！？.!? |
| 时间间隔 | > 1.2 秒 |
| 最大长度 | 1000 字符 |
| Overlap | 2 句 |

**DoD**:
- [ ] `lang_matches()` 只在 `language_utils.py` 定义一次
- [ ] 默认输出"块时间范围"（不按字符拆分）
- [ ] 单测覆盖率 ≥ 80%

**验收用例**:
1. 对比 3 类视频翻译质量（说话快/演讲/对话）
2. 句子完整度、代词一致性明显提升

---

### Phase 3: 断点续传 + Pipeline 拆分 (3-4 天)

**范围**:
- 新建 `core/state/manifest.py`（单一状态机）
- 拆分 `core/pipeline/single_video.py` 为阶段函数
- 实现原子写入 + chunk 级恢复
- 新建 `core/retry.py`（指数退避 + 抖动）

**整合精简任务**:
| 原文件 | 精简内容 | 预计减少 |
|--------|---------|---------|
| `single_video.py` | 拆分 376 行巨型函数为 5 个阶段函数 | 结构优化 |

**状态机设计 (单一状态)**:
```python
class VideoStage(Enum):
    PENDING = "pending"
    DETECTING = "detecting"
    DOWNLOADING = "downloading"
    TRANSLATING = "translating"
    SUMMARIZING = "summarizing"
    OUTPUTTING = "outputting"
    DONE = "done"
    FAILED = "failed"
    SKIPPED = "skipped"
```

**重试策略 (使用 tenacity)**:
```python
from tenacity import retry, stop_after_attempt, wait_exponential_jitter

@retry(
    stop=stop_after_attempt(5),
    wait=wait_exponential_jitter(multiplier=1, max=30, jitter=2),
    retry=retry_if_exception_type((NetworkError, RateLimitError)),
)
def api_call(...): ...
```

**DoD**:
- [ ] kill 后 `--resume` 能继续
- [ ] manifest 写入无竞争（单写者）
- [ ] chunk 级失败可恢复
- [ ] 无半截文件

---

### Phase 4: 时间预估 + 章节支持 (0.5 天)

**DoD**:
- [ ] ETA 文案走 `t()`
- [ ] 有 chapters 时输出章节化 Markdown
- [ ] 不引入额外 AI 调用

---

### Phase 5 (可选): UI 组件提取 (1-2 天)

**范围**:
- 提取 `ui/components/language_config_panel.py`
- 精简 `channel_page.py` 和 `url_list_page.py`

**预计精简**:
| 原文件 | 预计减少 |
|--------|---------|
| `channel_page.py` (637行) | ~150 行 |
| `url_list_page.py` (844行) | ~200 行 |

---

## 四、工程规范

### 4.1 i18n 规范

| 类别 | key 前缀 | 示例 |
|------|----------|------|
| 日志 | `log.` | `log.download.started` |
| UI | `ui.` | `ui.button.start` |
| 错误 | `error.` | `error.network.timeout` |
| 字幕 | `subtitle.` | `subtitle.merge.block_too_long` |
| 状态 | `state.` | `state.resume.from_chunk` |

**禁止行为**:
- 直接写中文/英文字符串
- 字符串拼接后再翻译（如 `t("error." + code)`）

### 4.2 日志规范

| 级别 | 语言 | 说明 |
|------|------|------|
| DEBUG | 英文 | 开发者排障用 |
| INFO+ | 本地化 | 走 `t()` |
| event_code | 英文稳定 | 用于统计/排障 |

```python
logger.info(
    event_code="DOWNLOAD_START",
    msg=t("log.download.started", video_id=vid)
)
```

### 4.3 原子写入规范

```python
tmp_path = Path("file.json.tmp")
final_path = Path("file.json")
tmp_path.write_text(data)
os.replace(tmp_path, final_path)  # 原子操作
```

### 4.4 错误分类

| 错误类型 | 是否重试 |
|----------|----------|
| 网络超时 | ✅ 是 |
| HTTP 429 | ✅ 是（尊重 Retry-After） |
| HTTP 5xx | ✅ 是 |
| HTTP 4xx (非429) | ❌ 否 |
| 视频不存在 | ❌ 标记 SKIPPED |
| 无字幕 | ❌ 标记 SKIPPED |

---

## 五、Code Review Checklist

### i18n
- [ ] 新增用户可见字符串全部走 `t()`/`tn()`
- [ ] 占位符为命名占位符，各语言一致
- [ ] 无新增硬编码日志/Markdown 字段

### 稳定性/并发
- [ ] 共享状态写入保证单写者
- [ ] 关键落盘用 tmp→replace（同目录）
- [ ] 重试使用指数退避+jitter
- [ ] 429 尊重 Retry-After

### 代码质量
- [ ] 函数 ≤ 100 行
- [ ] 完整类型注解
- [ ] 公共函数有 docstring
- [ ] 新模块测试覆盖率 ≥ 80%

---

## 六、发布门槛

- [ ] 单测覆盖：i18n、merger、manifest、retry
- [ ] 集成测试：10 视频、kill 恢复、chunk 恢复、100+ 长跑
- [ ] CI 门禁：key 一致性 + 硬编码检测

---

## 七、RFC2119 规范细则（GPT 补充）

> **MUST/SHOULD/MAY** 按 [RFC 2119](https://www.rfc-editor.org/rfc/rfc2119) 执行。门禁项必须能自动检测。

### 7.1 user-facing 范围定义

| 类型 | 是否 user-facing | i18n 要求 |
|------|-----------------|-----------|
| GUI 界面文案 | ✅ 是 | **MUST** 走 `t()` |
| CLI 输出 | ✅ 是 | **MUST** 走 `t()` |
| INFO+ 日志 | ✅ 是 | **MUST** 走 `t()` |
| 输出 Markdown 固定字段 | ✅ 是 | **MUST** 走 `t()` |
| DEBUG 日志 | ❌ 否 | **MUST** 英文 |
| 内部变量/注释 | ❌ 否 | 不适用 |

### 7.2 强制规范（MUST）

- **i18n**: 必须有 `t()` + `tn()`，占位符必须命名且跨语言一致；禁止拼接
- **manifest 写入**: 必须单写者（文件锁或写入队列）
- **关键落盘**: 必须 `tmp → os.replace` 且 tmp 同目录同盘
- **重试**: 必须指数退避+jitter，429 尊重 Retry-After

### 7.3 可选规范（MAY）

- WAL/复杂回写：标为 MAY，只有瓶颈出现再上
- 第三方 workflow 库：不引入，只用普通函数调用链

---

## 八、防跑偏指南（Grok 补充）

> IDE 工具没有参与审计过程，对"隐含意图"和"取舍背景"不敏感，容易跑偏。

### 8.1 Phase 1: i18n 最容易误解的地方

| 易错点 | 正确做法 |
|--------|---------|
| 翻译文件位置 | 把 `ui/i18n/*.json` **移动**到 `core/i18n/locales/` |
| fallback 行为 | `t(key)` 如果 key 不存在**必须返回 key 本身**，不是 None |
| logger 改造深度 | **只改入口**，暂时不拆分 `logger.py` |

### 8.2 Phase 2: 字幕合并最容易跑偏的地方

| 易错点 | 正确做法 |
|--------|---------|
| 时间轴处理 | **使用块起止时间范围**，不做字符比例拆回 |
| overlap | **默认关闭**，通过配置开关控制 |

### 8.3 Phase 3: 断点续传最容易出问题的地方

| 易错点 | 正确做法 |
|--------|---------|
| chunk 级恢复粒度 | **只有 translate 阶段**需要 `completed_chunks`，其他阶段只用 status |
| 原子写入 | 所有 manifest/输出必须 `tmp → os.replace` |
| Pipeline 拆分 | 只拆成普通函数调用链，**不引入新依赖** |

### 8.4 高并发与稳定性容易忽略的地方

| 易错点 | 正确做法 |
|--------|---------|
| 重试策略 | 必须用 tenacity 装饰器统一实现指数退避+jitter |
| 日志双层 | **每条日志必须有稳定的英文 event_code** |

### 8.5 本次不做的事项（明确边界）

- ❌ AI 配置硬编码抽离（`translation_summary_page.py` 前 200 行）
- ❌ UI 结构改动（只改 i18n 调用）
- ❌ 引入第三方 workflow/状态机框架

### 8.6 推荐的操作方式

1. **分 Phase 提示**：按 Phase 分步引导 IDE，不要一次性全部发送
2. **每步加约束**："不要提前实现后续功能，不要引入新依赖"
3. **先输出清单**：让 IDE 先输出文件变更清单，确认后再生成代码
4. **单独补测试**：每生成一个模块后，单独要求补单元测试
