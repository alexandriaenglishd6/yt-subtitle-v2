# 会话交接资料 - 2025-12-14

> **用途**：为新会话提供快速上手的上下文信息  
> **创建日期**：2025-12-14  
> **项目状态**：P0 任务基本完成，P1 任务进行中

---

## 📋 目录

1. [项目概览](#1-项目概览)
2. [当前任务状态](#2-当前任务状态)
3. [重要文档索引](#3-重要文档索引)
4. [关键代码文件](#4-关键代码文件)
5. [最近完成的工作](#5-最近完成的工作)
6. [待解决问题](#6-待解决问题)
7. [下一步计划](#7-下一步计划)

---

## 1. 项目概览

### 1.1 项目名称
**YouTube 字幕工具 v2** (yt-subtitle-v2)

### 1.2 项目类型
- **CLI 工具**：支持频道、播放列表、URL 列表模式
- **GUI 应用**：基于 customtkinter 的图形界面

### 1.3 核心功能
- 视频字幕检测、下载
- AI 翻译（支持多供应商）
- AI 摘要生成
- 双语字幕输出
- 增量管理（跳过已处理视频）
- 错误分类与失败记录

### 1.4 技术栈
- **Python 3.8+**
- **customtkinter**：GUI 框架
- **yt-dlp**：视频信息获取和字幕下载
- **LLM 客户端**：OpenAI、Anthropic、Google Gemini 等

---

## 2. 当前任务状态

### 2.1 已完成任务

#### P0 任务（核心功能）
- ✅ **P0-1 ~ P0-25**：CLI 完整流水线 + GUI 完整实现
  - CLI：检测、下载、翻译、摘要、输出、增量管理
  - GUI：骨架、国际化、主题系统、配置绑定
- ✅ **P0-T2**：CLI 入口测试（6/6 全部通过）
- ✅ **P0-T12**：GUI 骨架测试

#### P1 任务（增强功能）
- ✅ **P1-1**：双语字幕输出功能
- ✅ **P1-T1**：URL 列表模式测试

### 2.2 进行中的任务

#### UI 优化（2025-12-14）
- ⏸️ **下拉框高度调整**：部分完成
  - ✅ 通过减少选项数量（10个）降低高度
  - ❌ 手动翻页功能未实现（已回退）
- ⏸️ **语言代码标准化**：已实施第一步
- ⏸️ **源语言选择机制**：已实施第二步

### 2.3 待完成任务

#### 需求分析与实施方案（`需求分析与实施方案.md`）
- ⏳ **需求 1**：语言代码标准化（部分完成）
- ⏳ **需求 2**：源语言选择机制（部分完成）
- ⏳ **需求 3**：字幕格式扩展（TXT 格式，未开始）

---

## 3. 重要文档索引

### 3.1 核心规范文档（必读）

| 文档路径 | 说明 | 优先级 |
|---------|------|--------|
| `docs/v2_final_plan.md` | **行为规范**（最高优先级） | ⭐⭐⭐ |
| `docs/ide_任务表.md` | 任务清单和执行顺序 | ⭐⭐⭐ |
| `docs/ide_测试任务表.md` | 测试任务清单 | ⭐⭐⭐ |
| `docs/ide_integration.md` | IDE 行为约束 | ⭐⭐ |
| `docs/acceptance_criteria.md` | 验收标准 | ⭐⭐ |

### 3.2 开发日志和状态

| 文档路径 | 说明 | 最后更新 |
|---------|------|----------|
| `docs/dev_log.md` | **开发日志**（每日工作记录） | 2025-12-14 |
| `需求分析与实施方案.md` | 新需求分析和实施计划 | 2025-12-14 |
| `docs/新会话上下文恢复指南.md` | 会话恢复指南 | - |

### 3.3 架构和设计文档

| 文档路径 | 说明 |
|---------|------|
| `docs/project_blueprint.md` | 项目蓝图 |
| `docs/ai_design.md` | AI 调用设计规范 |
| `docs/AI_PROVIDER_EXTENSION.md` | AI 提供商扩展文档 |
| `docs/ui_plan.md` | UI 布局与交互设计 |

### 3.4 测试文档

| 文档路径 | 说明 |
|---------|------|
| `test_p1_t1_url_list_mode.md` | P1-T1 测试指南 |
| `test_p0_t2_cli.md` | P0-T2 测试指南 |
| `docs/测试执行文档.md` | 详细测试用例说明 |

---

## 4. 关键代码文件

### 4.1 核心模块

| 文件路径 | 说明 |
|---------|------|
| `core/pipeline.py` | **核心流水线**（检测→下载→翻译→摘要→输出） |
| `core/detector.py` | 字幕检测 |
| `core/downloader.py` | 字幕下载 |
| `core/translator.py` | AI 翻译 |
| `core/summarizer.py` | AI 摘要 |
| `core/output.py` | 输出模块（包括双语字幕） |
| `core/language.py` | 语言配置（LanguageConfig） |
| `core/llm_client.py` | LLM 客户端抽象接口 |
| `core/ai_providers.py` | LLM 客户端实现 |

### 4.2 GUI 模块

| 文件路径 | 说明 |
|---------|------|
| `ui/main_window.py` | 主窗口（布局与事件接线） |
| `ui/business_logic.py` | 业务逻辑（VideoProcessor） |
| `ui/pages/channel_page.py` | 频道模式页面 |
| `ui/pages/url_list_page.py` | URL 列表模式页面 |
| `ui/components/toolbar.py` | 顶部工具栏 |
| `ui/components/sidebar.py` | 左侧导航栏 |
| `ui/components/log_panel.py` | 日志输出面板 |
| `ui/fonts.py` | 字体配置（3种规格：22px/18px/14px） |
| `ui/themes.py` | 主题系统 |
| `ui/i18n_manager.py` | 国际化管理 |

### 4.3 配置管理

| 文件路径 | 说明 |
|---------|------|
| `config/manager.py` | 配置管理器（ConfigManager） |
| `cli/main.py` | CLI 入口 |

---

## 5. 最近完成的工作（2025-12-14）

### 5.1 UI 下拉框优化

**问题**：下拉框高度过高，需要手动翻页功能

**尝试的方法**：
1. ❌ `height` 参数调整（无效，只控制按钮高度）
2. ❌ 小字体（无效）
3. ✅ 减少选项数量（有效，从30个减少到10个）
4. ❌ 滚轮事件绑定（无效）
5. ❌ 键盘方向键（无效）
6. ❌ 外部/下方按钮（不符合需求）
7. ❌ 自定义下拉框组件（导致UI问题，已回退）

**最终方案**：
- 回退到标准 `CTkComboBox`
- 使用减少选项数量（10个）来降低高度
- 暂时放弃手动翻页功能

**相关文件**：
- `ui/pages/channel_page.py`：源语言下拉框（10个选项）
- `ui/pages/url_list_page.py`：源语言下拉框（10个选项）

### 5.2 语言代码标准化（部分完成）

**实施内容**：
- ✅ 添加 `normalize_language_code()` 函数（`core/language.py`）
- ✅ 配置加载时自动转换（`LanguageConfig.from_dict`）
- ✅ 字幕检测时应用标准化（`core/detector.py`）

**待完成**：
- ⏳ 下载和翻译模块的语言匹配逻辑优化

### 5.3 源语言选择机制（部分完成）

**实施内容**：
- ✅ 添加 `source_language` 字段到 `LanguageConfig`
- ✅ 实现优先级列表（`en` > `zh-CN` > `ja` > `de`...）
- ✅ 实现自动模式和指定模式（`core/downloader.py`, `core/translator.py`）
- ✅ GUI 下拉框（10个选项，包括"自动"）

**待完成**：
- ⏳ 测试验证

---

## 6. 待解决问题

### 6.1 已搁置的问题

| 问题 | 状态 | 说明 |
|------|------|------|
| 下拉框内部翻页按钮 | ⏸️ 已搁置 | customtkinter 限制，需要完全自定义组件或第三方库 |

### 6.2 待实施的需求

| 需求 | 状态 | 文档 |
|------|------|------|
| TXT 字幕格式支持 | ⏳ 未开始 | `需求分析与实施方案.md` 需求3 |
| 语言代码标准化完善 | ⏳ 部分完成 | `需求分析与实施方案.md` 需求1 |
| 源语言选择机制测试 | ⏳ 待测试 | `需求分析与实施方案.md` 需求2 |

---

## 7. 下一步计划

### 7.1 短期计划（优先级高）

1. **测试源语言选择机制**
   - 验证自动模式优先级列表
   - 验证指定模式回退机制
   - 测试语言代码匹配逻辑

2. **完善语言代码标准化**
   - 确保所有模块都应用标准化
   - 测试各种语言代码格式的兼容性

3. **继续 P1 任务**
   - P1-2：URL 列表模式增强（如需要）
   - P1-3：其他增强功能

### 7.2 中期计划（按需）

1. **TXT 字幕格式支持**
   - 实现 TXT 格式输出（无时间轴）
   - 双语字幕垂直布局

2. **下拉框翻页功能**
   - 评估完全自定义组件的可行性
   - 或寻找第三方组件库

---

## 8. 关键技术点

### 8.1 语言代码处理

**标准化规则**：
- 除了 `zh-CN` 和 `zh-TW` 外，其他语言使用简短格式（`en` 而不是 `en-US`）
- 自动转换：`en-US` → `en`

**相关函数**：
- `core/language.py`：`normalize_language_code()`
- `core/language.py`：`LanguageConfig.from_dict()`（自动应用标准化）

### 8.2 源语言选择逻辑

**优先级列表**（固定，不可配置）：
```
en > zh-CN > ja > de > fr > es > ru > pt > ko > it > ar > hi
```

**选择机制**：
1. 如果用户指定了源语言，优先使用指定语言
2. 如果指定语言不存在，回退到自动模式（使用优先级列表）
3. 如果用户选择"自动"，直接使用优先级列表匹配

**相关函数**：
- `core/downloader.py`：`_determine_source_language()`（下载时选择源语言）
- `core/translator.py`：`_determine_source_language()`（翻译时选择源语言）
- `core/language.py`：`lang_matches()`（语言代码模糊匹配，支持 `en` 匹配 `en-US`）

---

## 9. 测试任务状态

### 9.1 T0 红线级测试（必测）

| 测试编号 | 测试名称 | 状态 | 说明 |
|---------|---------|------|------|
| T0-1 | AI 架构 + LLM 参数测试 | ⏸️ 暂缓 | 等更多 AI 供应商接入后测试 |
| T0-2 | Archive 位置 + 迁移测试 | ✅ 已完成 | - |
| T0-3 | Dry Run 只读测试 | ✅ 已完成 | - |
| T0-4 | 文件写入锁 + 原子写测试 | ✅ 已完成 | - |
| T0-5 | 临时目录清理测试 | ✅ 已完成 | - |

### 9.2 T1 高优先级测试

| 测试编号 | 测试名称 | 状态 | 说明 |
|---------|---------|------|------|
| T1-1 | 错误分类与失败记录测试 | ✅ 部分完成 | RATE_LIMIT 暂缓 |
| T1-2 | 取消功能测试 | ✅ 部分完成 | 摘要阶段取消暂缓 |
| T1-3 | 代理健康管理测试 | ✅ 已完成 | - |
| T1-4 | AI 并发限流测试 | ✅ 已完成 | - |

### 9.3 T2 中期优化测试

| 测试编号 | 测试名称 | 状态 | 说明 |
|---------|---------|------|------|
| T2-1 | 结构化失败记录测试 | ✅ 已完成 | - |

### 9.4 P0/P1 功能测试

| 测试编号 | 测试名称 | 状态 | 说明 |
|---------|---------|------|------|
| P0-T1 | 配置管理 | ✅ 已完成 | - |
| P0-T2 | CLI 入口 | ✅ 已完成 | - |
| P0-T3 | 视频解析 | ✅ 已完成 | - |
| P0-T4 | 增量管理 | ✅ 已完成 | - |
| P0-T5 | 字幕检测 | ✅ 已完成 | - |
| P0-T6 | Dry Run | ✅ 已完成 | - |
| P0-T7 | 字幕下载 | ✅ 已完成 | - |
| P0-T8 | AI 翻译 | ✅ 已完成 | - |
| P0-T9 | 输出模块 | ✅ 已完成 | - |
| P0-T10 | 失败记录 | ✅ 已完成 | - |
| P0-T11 | 并发执行 | ✅ 已完成 | - |
| P0-T12 | GUI 骨架 | ✅ 已完成 | - |
| P1-T1 | URL 列表模式 | ✅ 已完成 | - |
| P1-T2 | 双语字幕 | ⏸️ 部分完成 | 测试中遇到问题，已修复部分 |

**详细测试文档**：`docs/ide_测试任务表.md`

---

## 10. 重要配置和路径

### 10.1 配置文件位置

| 配置类型 | 文件路径 | 说明 |
|---------|---------|------|
| 应用配置 | `config.json`（用户数据目录） | 主配置文件，包含所有设置 |
| 语言配置 | `config.json` 中的 `language_config` | 语言相关配置 |
| AI 配置 | `config.json` 中的 `ai_config` | AI 供应商和模型配置 |
| Cookie | `cookies.txt`（用户数据目录） | YouTube Cookie 文件（Netscape 格式） |
| 代理列表 | `config.json` 中的 `proxies` | 代理服务器列表 |

### 10.2 输出目录结构

```
out/
├── <channel_name> [<channel_id>]/
│   ├── <video_id> <title>/
│   │   ├── original.<lang>.srt          # 原始字幕
│   │   ├── translated.<lang>.srt        # 翻译字幕
│   │   ├── bilingual.<source>-<target>.srt  # 双语字幕
│   │   ├── summary.<lang>.txt           # 摘要
│   │   └── metadata.json                # 元数据
├── archives/                            # 增量管理文件（新位置）
│   └── <channel_id>.txt
├── failed_urls.txt                      # 失败 URL 列表
├── failed_detail.log                    # 失败详情日志
└── failed_records.json                  # 失败记录（JSON 格式）
```

### 10.3 临时目录

- **路径**：`temp/`（项目根目录）
- **清理策略**：每次任务结束后自动清理
- **保留策略**：失败时根据配置决定是否保留（`keep_temp_on_error`）

---

## 11. 常见问题和解决方案

### 11.1 已解决的问题

| 问题 | 解决方案 | 相关文件 |
|------|---------|---------|
| 语言代码匹配失败（en vs en-US） | 实现模糊匹配逻辑 | `core/downloader.py`, `core/translator.py` |
| Cookie 文件格式错误分类 | 修复为 AUTH 错误 | `core/fetcher.py` |
| 官方字幕输出缺失 | 修复 translation_result 补充逻辑 | `core/pipeline.py` |
| GUI 按钮卡死 | 修复线程安全回调 | `ui/main_window.py` |
| 双语字幕生成失败（VTT 格式） | 添加 VTT 解析支持 | `core/output.py` |
| 双语字幕繁体中文问题 | 修复 Google Translate 处理 | `core/ai_providers.py`, `core/prompts.py` |
| 下拉框高度过高 | 减少选项数量（10个） | `ui/pages/channel_page.py`, `ui/pages/url_list_page.py` |

### 11.2 已知限制

| 限制 | 说明 | 影响 |
|------|------|------|
| customtkinter CTkComboBox | 无法在下拉列表内部添加自定义控件 | 无法实现内部翻页按钮 |
| 滚轮事件绑定 | Windows 上无法正常工作 | 无法通过滚轮实现手动翻页 |
| 键盘方向键 | 只能在页面内移动，无法翻页 | 无法通过键盘实现手动翻页 |

---

## 12. 开发环境设置

### 12.1 必需依赖

```bash
pip install -r requirements.txt
```

**主要依赖**：
- `customtkinter`：GUI 框架
- `yt-dlp`：视频信息获取和字幕下载
- `openai`：OpenAI API 客户端
- `anthropic`：Anthropic API 客户端
- `google-generativeai`：Google Gemini API 客户端
- `deep-translator`：Google Translate 免费翻译

### 12.2 环境变量（可选）

- `OPENAI_API_KEY`：OpenAI API Key
- `ANTHROPIC_API_KEY`：Anthropic API Key
- `GOOGLE_API_KEY`：Google Gemini API Key

### 12.3 运行方式

**CLI 模式**：
```bash
# 频道模式
python cli.py channel --url "https://www.youtube.com/@channel_name"

# URL 列表模式
python cli.py urls --file test_urls.txt

# Dry Run 模式（仅检测，不下载）
python cli.py channel --url "..." --dry-run

# 强制重跑（忽略历史记录）
python cli.py channel --url "..." --force
```

**GUI 模式**：
```bash
python main.py
```

### 12.4 用户数据目录

**Windows**：
- `%APPDATA%\yt-subtitle-v2\`
- 包含：`config.json`、`cookies.txt`、`archives/` 目录

**Linux/Mac**：
- `~/.config/yt-subtitle-v2/`
- 包含：`config.json`、`cookies.txt`、`archives/` 目录

---

## 13. 核心代码结构说明

### 13.1 核心流程函数

**主要入口函数**：
- `core/pipeline.py`：`process_video_list()` - 批量处理视频列表
- `core/pipeline.py`：`process_single_video()` - 处理单个视频
- `ui/business_logic.py`：`VideoProcessor` 类 - GUI 业务逻辑封装

**关键处理函数**：
- `core/detector.py`：`detect_subtitles()` - 检测字幕可用性
- `core/downloader.py`：`download_subtitles()` - 下载字幕
- `core/downloader.py`：`_determine_source_language()` - 确定源语言（自动/指定）
- `core/translator.py`：`translate_subtitles()` - AI 翻译
- `core/translator.py`：`_determine_source_language()` - 确定源语言（自动/指定）
- `core/summarizer.py`：`summarize_subtitles()` - AI 摘要
- `core/output.py`：`write_all()` - 写入所有输出文件
- `core/output.py`：`write_bilingual_subtitle()` - 生成双语字幕

### 13.2 语言处理函数

**语言代码标准化**：
- `core/language.py`：`normalize_language_code()` - 标准化语言代码（`en-US` → `en`）
- `core/language.py`：`LanguageConfig.from_dict()` - 配置加载时自动应用标准化

**语言匹配**：
- `core/downloader.py`：`lang_matches()` - 模糊匹配（`en` 匹配 `en-US`）
- `core/translator.py`：`lang_matches()` - 模糊匹配（`en` 匹配 `en-US`）

**源语言选择**：
- 优先级列表（固定）：`en` > `zh-CN` > `ja` > `de` > `fr` > `es` > `ru` > `pt` > `ko` > `it` > `ar` > `hi`
- 自动模式：按优先级列表匹配
- 指定模式：用户指定源语言，不存在时回退到自动模式

### 13.3 配置管理

**配置类**：
- `config/manager.py`：`ConfigManager` - 配置管理器
- `config/manager.py`：`AppConfig` - 应用配置数据类
- `core/language.py`：`LanguageConfig` - 语言配置数据类

**配置字段**：
- `language_config`：语言相关配置（UI语言、目标语言、源语言、双语模式、翻译策略）
- `ai_config`：AI 配置（翻译和摘要分别配置）
- `run_params`：运行参数（并发数、输出目录等）
- `network_config`：网络配置（代理、Cookie）

---

## 14. 调试和故障排查

### 14.1 常见错误类型

| 错误类型 | 说明 | 常见原因 |
|---------|------|---------|
| `NETWORK` | 网络错误 | 代理配置错误、网络连接问题 |
| `AUTH` | 认证错误 | Cookie 无效、API Key 无效 |
| `CONTENT` | 内容错误 | 无可用字幕、翻译策略不匹配 |
| `RATE_LIMIT` | 限流错误 | API 调用频率过高 |
| `UNKNOWN` | 未知错误 | 其他未分类错误 |

### 14.2 日志文件位置

| 日志类型 | 文件路径 | 说明 |
|---------|---------|------|
| 应用日志 | 控制台输出 | 实时显示处理进度 |
| 失败详情 | `out/failed_detail.log` | 详细失败信息（包含错误类型） |
| 失败 URL | `out/failed_urls.txt` | 失败视频 URL 列表 |
| 失败记录 | `out/failed_records.json` | 结构化失败记录（JSON 格式） |

### 14.3 调试技巧

1. **启用详细日志**：
   - 检查 `core/logger.py` 的日志级别设置
   - 默认级别：INFO

2. **检查配置文件**：
   - 查看用户数据目录下的 `config.json`
   - 验证配置格式是否正确

3. **测试单个组件**：
   - 使用 `test_*.py` 脚本测试单个模块
   - 例如：`test_language_config.py`、`test_llm_client.py`

4. **检查临时文件**：
   - 查看 `temp/` 目录（如果任务失败且配置保留）
   - 临时文件可能包含错误信息

5. **验证网络连接**：
   - 使用 `cli.py cookie test` 测试 Cookie
   - 检查代理配置是否正确

---

## 15. 重要设计决策

### 15.1 语言代码标准化

**决策**：除了 `zh-CN` 和 `zh-TW` 外，其他语言使用简短格式

**原因**：
- YouTube 检测到的语言代码通常是简短格式（如 `en`）
- 用户可能输入完整格式（如 `en-US`）
- 统一标准避免匹配失败

**实施**：
- `normalize_language_code()` 函数自动转换
- 配置加载时自动应用
- 字幕检测时自动应用

### 15.2 源语言选择机制

**决策**：固定优先级列表 + 用户指定选项

**原因**：
- 大多数用户使用常见语言（英语、中文等）
- 固定优先级列表可以覆盖 99% 的使用场景
- 用户指定选项提供灵活性

**实施**：
- 优先级列表：`en` > `zh-CN` > `ja` > `de` > `fr` > `es` > `ru` > `pt` > `ko` > `it` > `ar` > `hi`
- 自动模式：按优先级匹配
- 指定模式：用户指定，不存在时回退

### 15.3 下拉框高度优化

**决策**：通过减少选项数量降低高度，放弃内部翻页按钮

**原因**：
- customtkinter 的 `CTkComboBox` 不支持在下拉列表内部添加自定义控件
- 减少选项数量（10个）可以有效降低高度
- 完全自定义组件开发成本高，且可能导致 UI 问题

**实施**：
- 源语言选项：10个（自动 + 9种常用语言）
- 目标语言选项：10个（常用语言）

---

## 16. 版本信息和依赖

### 16.1 Python 版本要求

- **最低版本**：Python 3.8+
- **推荐版本**：Python 3.10+

### 16.2 主要依赖版本

| 包名 | 用途 | 版本要求 |
|------|------|---------|
| `customtkinter` | GUI 框架 | 最新版 |
| `yt-dlp` | 视频信息获取 | 最新版 |
| `openai` | OpenAI API | 最新版 |
| `anthropic` | Anthropic API | 最新版 |
| `google-generativeai` | Google Gemini API | 最新版 |
| `deep-translator` | Google Translate | 最新版 |

### 16.3 项目结构

```
yt-subtitle-v2/
├── cli/              # CLI 命令模块
├── core/             # 核心业务逻辑
├── config/           # 配置管理
├── ui/               # GUI 界面
│   ├── components/   # UI 组件
│   ├── pages/        # 页面
│   └── i18n/         # 国际化文件
├── docs/             # 文档
├── tests/            # 测试脚本
├── out/              # 输出目录
├── temp/             # 临时目录
├── main.py           # GUI 入口
├── cli.py            # CLI 入口
└── requirements.txt  # 依赖列表
```

---

## 17. 快速上手检查清单

### 17.1 新会话开始时

- [ ] 阅读 `docs/v2_final_plan.md`（行为规范，最高优先级）
- [ ] 阅读 `docs/ide_任务表.md`（了解任务清单和顺序）
- [ ] 阅读 `docs/dev_log.md`（了解最近的工作进展）
- [ ] 阅读 `需求分析与实施方案.md`（了解待实施的需求）
- [ ] 检查 `docs/ide_测试任务表.md`（了解测试状态）

### 17.2 开始新任务前

- [ ] 确认任务在 `docs/ide_任务表.md` 中的位置和依赖
- [ ] 检查是否有相关的测试任务（`docs/ide_测试任务表.md`）
- [ ] 查看 `docs/dev_log.md` 中是否有相关历史记录
- [ ] 确认代码修改是否符合 `docs/v2_final_plan.md` 的行为规范

### 17.3 完成任务后

- [ ] 更新 `docs/ide_任务表.md` 中的任务状态
- [ ] 更新 `docs/dev_log.md` 记录工作内容
- [ ] 如有测试任务，更新 `docs/ide_测试任务表.md` 的测试状态
- [ ] 检查代码是否符合规范（`docs/ide_integration.md`）

---

## 18. 联系和参考

### 18.1 关键文档快速索引

| 文档 | 用途 | 优先级 |
|------|------|--------|
| `docs/v2_final_plan.md` | **行为规范**（最高优先级） | ⭐⭐⭐ |
| `docs/ide_任务表.md` | 任务清单和执行顺序 | ⭐⭐⭐ |
| `docs/ide_测试任务表.md` | 测试任务清单 | ⭐⭐⭐ |
| `docs/dev_log.md` | 开发日志（每日工作记录） | ⭐⭐ |
| `需求分析与实施方案.md` | 新需求分析和实施计划 | ⭐⭐ |
| `docs/新会话上下文恢复指南.md` | 会话恢复指南 | ⭐ |

### 18.2 重要提醒

1. **行为规范优先**：`docs/v2_final_plan.md` 是最高优先级，任何实现必须符合此文档
2. **任务顺序**：严格按照 `docs/ide_任务表.md` 中的顺序执行
3. **代码规范**：遵循 `docs/ide_integration.md` 中的 IDE 行为约束
4. **测试优先**：完成功能后必须进行测试，更新测试状态
5. **日志记录**：重要工作完成后更新 `docs/dev_log.md`

---

## 19. 当前已知问题和限制

### 19.1 UI 限制

| 问题 | 状态 | 说明 |
|------|------|------|
| 下拉框内部翻页按钮 | ⏸️ 已搁置 | customtkinter 限制，需要完全自定义组件 |
| 滚轮事件绑定 | ❌ 不可行 | Windows 上无法正常工作 |
| 键盘方向键翻页 | ❌ 不可行 | 只能在页面内移动，无法翻页 |

### 19.2 功能限制

| 功能 | 状态 | 说明 |
|------|------|------|
| TXT 字幕格式 | ⏳ 未开始 | 待实施（`需求分析与实施方案.md` 需求3） |
| 语言代码标准化完善 | ⏳ 部分完成 | 需要确保所有模块都应用 |
| 源语言选择机制测试 | ⏳ 待测试 | 需要验证自动模式和指定模式 |

---

## 20. 代码修改注意事项

### 20.1 线程安全

**GUI 更新必须在主线程**：
- 使用 `self.after(0, ...)` 确保 UI 更新在主线程执行
- 业务逻辑在后台线程执行，通过回调更新 UI

**相关文件**：
- `ui/main_window.py`：主窗口线程安全回调
- `ui/business_logic.py`：业务逻辑封装

### 20.2 错误处理

**统一异常系统**：
- `core/exceptions.py`：`AppException` + `ErrorType`
- `core/llm_client.py`：`LLMException` + `LLMErrorType`
- 所有错误必须正确分类和记录

**错误传递**：
- 使用 `on_log` 回调实时传递错误信息到 UI
- 使用 `FailureLogger` 记录失败详情

### 20.3 配置管理

**配置加载**：
- 启动时从 `config.json` 加载所有配置
- 使用 `ConfigManager` 统一管理

**配置保存**：
- 用户操作后自动保存到 `config.json`
- 关键配置保存后自动重新初始化组件

### 20.4 语言处理

**语言代码标准化**：
- 配置加载时自动应用 `normalize_language_code()`
- 字幕检测时自动应用标准化
- 确保所有模块使用统一标准

**语言匹配**：
- 使用 `lang_matches()` 进行模糊匹配
- 支持 `en` 匹配 `en-US`（但 `zh-CN` 和 `zh-TW` 不互相匹配）

---

**文档结束**

> **提示**：新会话开始时，建议先阅读第 17 节的"快速上手检查清单"，然后根据具体任务查阅相关章节。