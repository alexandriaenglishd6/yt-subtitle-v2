# YouTube 字幕工具 – IDE 开发任务表（P0 / P1）

> ⚠️ 给所有 AI / IDE 的总声明  
>
> 本项目有两份核心文档：  
> 1. `docs/project_blueprint.md`（项目蓝图）：说明工具的目标、使用场景、整体架构和 UI 骨架。  
> 2. `docs/v2_final_plan.md`（行为规范）：详细定义 Dry Run、增量处理、目录结构、配置路径、并发与代理、语言配置等“硬规则”。  
>
> 另外还有两份配套文档：  
> 3. `docs/ui_plan.md`（可选）：UI 布局细化。  
> 4. `docs/acceptance_criteria.md`：验收标准。  
> 5. `docs/ide_integration.md`：IDE 行为约束（MUST / MUST NOT）。  
>
> **所有代码实现、重构和行为调整必须以 `v2_final_plan.md` 为准。**
>
> - 当蓝图与 `v2_final_plan.md` 不一致时，以 `v2_final_plan.md` 为准。  
> - 如需修改 Dry Run / 增量 / 输出目录 / 并发 & 代理 / 语言配置 等语义，必须先修改文档并得到我的确认，再让 IDE 修改代码。  
> - 任何 AI / IDE 不得自行改变上述核心语义。

---

## 1. 文档目的

这份任务表用于我和 IDE AI 的“开发合同”：

- 把 P0 / P1 的开发任务全部列清楚；
- 为每个任务给出：
  - 简要说明；
  - 依赖关系；
  - 预估工作量（粗略，用于排期，非严格承诺）；
- 任务的**执行顺序以本表为准**，没有特殊情况不要随意打乱；
- 如确需变更任务顺序或内容，必须先和我沟通，并更新本任务表后再执行。

> 时间估算说明：  
> 下文“工作量”是面向熟悉代码/工具链的开发者或 IDE 的粗略估算，只用于区分任务大小：  
> - XS：< 1 小时  
> - S：约 1–3 小时  
> - M：约 0.5–1 天  
> - L：约 1–2 天  
> （不是对助手 / IDE 的强制承诺，只是帮助排优先级）

---

## 2. 开发前必须阅读的文档

IDE 在开始任何任务前，必须先阅读并理解：

1. `docs/project_blueprint.md` – 项目蓝图  
2. `docs/v2_final_plan.md` – 行为规范（**最高优先级**）  
3. `docs/ui_plan.md` – UI 布局细化（GUI 阶段特别重要）  
4. `docs/acceptance_criteria.md` – 验收标准  
5. `docs/ide_integration.md` – IDE 行为约束（MUST / MUST NOT）

---

## 3. P0 任务列表（MVP 必须完成，按顺序执行）

> 说明：P0 是**最小可用版本**必须完成的任务。  
> 除非我主动同意调整，IDE 应按编号从 P0-1 往下执行，不跳步。

### 3.1 P0 任务总表

| 编号  | 任务名称                         | 简要说明                                                                                                                                              | 依赖                       | 预估工作量 | 状态   |
|-------|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|----------|--------|
| P0-1  | 项目骨架 & 基础目录结构         | 创建 `core/`、`ui/`、`config/`、`out/`、`tests/` 等基础目录和空模块文件，搭建最小项目骨架。                                                           | 无                         | S        | ✅ 完成 |
| P0-2  | ConfigManager & 用户数据目录    | 实现配置模型 + 在用户数据目录读写 `config.json`（不含 UI），路径符合 `v2_final_plan.md` 约定。                                                        | P0-1                       | S        | ✅ 完成 |
| P0-3  | 日志系统（文件 + 控制台）       | 实现统一 Logger，支持写入日志文件（用户数据目录）和控制台输出，为后续 UI 日志复用。                                                                  | P0-1                       | S        | ✅ 完成 |
| P0-4  | CLI 入口 & 最小命令结构         | 实现基础 CLI：支持 `channel --url` / `urls --file` 两种命令框架，暂时可返回"未实现"提示，为后续 Dry Run / 全流程闭环做准备。                          | P0-1, P0-2                 | S        | ✅ 完成 |
| P0-5  | 视频解析（频道 / 列表 / 单 URL）| 根据 URL 类型调用 yt-dlp 获取视频列表（频道 / 播放列表 / 单视频 / 批量 URL 列表），返回标准化 `VideoInfo` 列表。                                     | P0-4                       | M          | ✅ 完成 |
| P0-5-fix | 批量 URL 列表 CLI 集成补丁 | 补充 CLI 中 `urls_command()` 的实际调用，使批量 URL 列表解析功能完整可用。                                                                        | P0-5                       | XS         | ✅ 完成 |
| P0-6  | 增量管理基础（archives）        | 实现 `IncrementalManager`，在用户数据目录 `archives/` 下记录已处理视频 ID（目前只写接口，不完全接入流水线）。                                       | P0-5                       | S          | ✅ 完成 |
| P0-7  | 字幕检测（单视频）              | 实现 `SubtitleDetector`：对单个视频返回是否有字幕、人工字幕语言列表、自动字幕语言列表。                                                              | P0-5                       | M          | ✅ 完成 |
| P0-8  | Dry Run 模式（仅检测 + 日志输出）| 在 CLI 中实现 Dry Run：只调用 `SubtitleDetector` 批量检测，结果输出到日志，严格遵守"只检测、不下载、不摘要、不写报告、不更新增量"的语义。           | P0-7, P0-3                 | M          | ✅ 完成 |
| P0-9  | 批量检测 + 增量接入             | 把 `IncrementalManager` 接入 Dry Run 和正常处理流程：**针对频道 / 播放列表 / URL 列表**，第二次处理时只对未成功处理的视频做检测/处理；Dry Run 不更新增量。 | P0-6, P0-8                 | M          | ✅ 完成 |
| P0-10 | 字幕下载模块                    | 实现 `SubtitleDownloader`：根据检测结果和翻译策略，下载原始字幕（原语言）以及官方翻译字幕（如有），暂不调用 AI 翻译。                              | P0-7, P0-3                 | M          | ✅ 完成 |
| P0-11 | LanguageConfig & 翻译策略       | 实现 `LanguageConfig`，定义 UI 语言、字幕目标语言、摘要语言、双语模式、翻译策略等；所有翻译 / 摘要逻辑必须从这里读配置。                             | P0-2                       | S          | ✅ 完成 |
| P0-12 | AI 翻译模块（单目标语言）       | 实现 `SubtitleTranslator`：在 `OFFICIAL_AUTO_THEN_AI` 等策略下，当官方字幕不足时调用 AI 翻译生成目标语言字幕（先支持一个主目标语言）。             | P0-10, P0-11               | M          | ✅ 完成 |
| P0-12-fix | AI 翻译模块规范修复 | 重构 `SubtitleTranslator` 以符合 `ai_design.md` 规范：使用 `LLMClient` 接口，统一错误处理，支持重试逻辑。 | P0-12 | XS | ✅ 完成 |
| P0-13 | AI 摘要模块（单语言）           | 实现 `Summarizer`：调用大模型对字幕文本生成单语言摘要；Prompt 模板集中在 `core/prompts.py`，不能写死"中文"，必须通过 `LanguageConfig` 注入语言。   | P0-11                      | M          | ✅ 完成 |
| P0-13-fix | AI 摘要模块规范修复 | 重构 `Summarizer` 以符合 `ai_design.md` 规范：使用 `LLMClient` 接口，统一错误处理，支持重试逻辑。 | P0-13 | XS | ✅ 完成 |
| P0-14 | 输出模块（目录结构 & 文件）     | 实现 `OutputWriter`：按 `v2_final_plan.md` 规定的结构创建目录和文件（`original` / `translated` / `summary` / `metadata`），使用语言代码命名。       | P0-10, P0-12, P0-13        | M          | ✅ 完成 |
| P0-15 | 失败记录 & `failed.txt`         | 实现失败记录器：所有下载 / 翻译 / 摘要失败的视频，写入 `out/failed_detail.log` 和 `out/failed_urls.txt`；格式可读，追加写入。                        | P0-3, P0-14                | S          | ✅ 完成 |
| P0-16 | 并发执行器 & 任务调度           | 实现 `TaskRunner`：队列 + worker 池并发执行，支持配置并发数；并发默认值保守（3），不在代码中硬锁死上限，对过高配置只做日志警告。                  | P0-5, P0-10, P0-12, P0-13  | L          | ⏳ 待开始 |
| P0-17 | 代理支持 & 简易健康管理         | 支持多代理列表（数量不锁死）；实现简单健康逻辑（连续失败 N 次暂时禁用，过一段时间再试）；不实现复杂评分系统。                                     | P0-16                      | M          | ⏳ 待开始 |
| P0-18 | Cookie 支持 & 测试逻辑          | 支持从配置中读取 Cookie；实现一个"测试请求"函数，用于检查 Cookie 是否可用、所在地区；结果输出到日志。                                            | P0-5                       | S          | ⏳ 待开始 |
| P0-19 | CLI 完整流水线闭环             | 将以上模块串联：通过 CLI 可从**频道 / URL 列表** → 增量筛选 → 检测 → 下载 → 翻译 → 摘要 → 输出目录结构，跑通完整流程。                           | P0-9, P0-14, P0-15, P0-16, P0-17, P0-18 | L | ⏳ 待开始 |
| P0-20 | Smoke Test 编写                 | 在 `tests/test_smoke.py` 中实现一个小频道 / URL 流水线测试脚本，自动验证输出目录结构、文件数量、基本内容存在。                                    | P0-19                      | S          | ⏳ 待开始 |
| P0-21 | GUI 骨架（无完整功能）         | 搭建 GUI 基本框架：顶部工具栏 + 左侧侧边栏 + 中间主区 + 底部日志框；先用假数据 / 简单方法接日志和"开始处理"按钮。                                | P0-3, P0-4                 | M          | ⏳ 待开始 |
| P0-22 | GUI 接入核心流水线（基础）      | 在 GUI 中接入最小功能：频道 URL 输入 + "开始处理"按钮 + 底部日志实时显示（调用核心 pipeline 的接口）。                                              | P0-19, P0-21               | M          | ⏳ 待开始 |
| P0-23 | UI 国际化（中英）              | 将 GUI 文案全部接入 i18n（`zh-CN` / `en-US`），实现语言切换；不硬编码中文 / 英文。                                                                    | P0-21                      | M          | ⏳ 待开始 |
| P0-24 | 主题系统（4 套主题）           | 实现基于 token 的主题系统，只提供 4 个主题（白 / 浅灰 / 深灰 / Claude 暖色），支持 UI 中切换。                                                       | P0-21                      | M          | ⏳ 待开始 |
| P0-25 | 配置与 GUI 绑定                | 把已有的 ConfigManager 接入 GUI：启动时加载配置初始化控件，关闭 / 点击保存时写回配置（语言、并发、代理、Cookie、目标语言等）。                    | P0-2, P0-22, P0-23         | M          | ⏳ 待开始 |

> ⚠️ 执行顺序要求：  
> - P0-1 ～ P0-5 建议作为第一轮里程碑：**CLI 最小闭环的基础（到字幕检测）**。  
> - P0-6 ～ P0-15 构成第二轮：**完整 CLI 闭环 + 增量 + 输出结构 + 失败记录**。  
> - P0-16 ～ P0-20 为第三轮：**并发性能 + 代理 + Cookie + smoke test**。  
> - P0-21 ～ P0-25 为第四轮：**GUI 骨架 + i18n + 主题 + 配置绑定**。

---

## 4. P1 任务列表（增强功能）

> P1 任务在 P0 全部完成并稳定后再做。  
> 同样按编号顺序执行，除非我明确同意调整。

| 编号  | 任务名称                    | 简要说明                                                                                                                                      | 依赖            | 预估工作量 | 状态   |
|-------|-----------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|-----------------|----------|--------|
| P1-1  | 双语字幕输出                | 在 `OutputWriter` 中增加双语字幕生成逻辑：`bilingual.<source>-<target>.srt`，遵守 `LanguageConfig.bilingual_mode` 配置。                     | P0-14           | M        | ⏳ 待开始 |
| P1-2  | URL 列表模式（CLI + GUI）   | 支持粘贴多行 URL 的批量处理模式，在 CLI 和 GUI 中都提供入口。CLI 底层能力已在 P0 阶段具备，本任务主要完善模式入口和交互。                   | P0-19, P0-22    | M        | ⏳ 待开始 |
| P1-3  | 增量高级选项                | 提供"全量重跑某个频道 / 列表"的配置/按钮；实现安全的 archive 清空/忽略逻辑，操作需二次确认。                                                 | P0-9, P0-25     | S        | ⏳ 待开始 |
| P1-4  | 错误分类 & 重试策略         | 对网络错误、字幕不存在、AI 限流等进行分类展示；实现简单的重试次数配置；在日志中打印清晰原因。                                                | P0-19           | M        | ⏳ 待开始 |
| P1-5  | 更详细的进度展示            | 在 CLI 和 GUI 中展示总进度、当前正在处理的视频、估计剩余时间（粗略即可，属于"仅供参考"）。                                                   | P0-16, P0-22    | S        | ⏳ 待开始 |
| P1-6  | 高级日志视图（可选）        | 在 GUI 中提供简单的日志级别过滤（`INFO` / `WARN` / `ERROR`），支持暂停自动滚动。                                                             | P0-22           | S        | ⏳ 待开始 |
| P1-7  | 配置导入 / 导出             | 支持导出当前配置为 JSON 文件、导入配置文件覆盖当前配置（带二次确认）。                                                                        | P0-2, P0-25     | S        | ⏳ 待开始 |

---

## 5. 和 IDE 的沟通规则

IDE 在执行任务时，请遵守以下流程：

### 5.1 每个任务开始前

1. **声明当前任务编号与名称**：  
   例如：「现在执行 P0-7 字幕检测（单视频）」。
2. **引用约束文档**：  
   说明本任务相关的 `v2_final_plan.md` 段落（例如 Dry Run、小节、输出结构部分）。
3. **复述理解（用简短中文）**：
   - 你理解的该任务目标是什么；
   - 需要修改 / 创建哪些文件；
   - 不会动哪些区域（尤其是已经稳定的 P0 模块）。
4. **提交执行计划（几条 bullet）**：
   - 步骤 1：…  
   - 步骤 2：…  

等待我确认后再开始写代码。

### 5.2 每个任务结束后

1. 列出本次修改的文件和主要改动点。  
2. 描述如何验证本任务（命令 / 步骤），并报告验证结果：
   - 成功场景测试；  
   - 失败场景测试（如 Dry Run / 网络错误模拟）。
3. 明确说明：
   - 当前实现是否**完全符合** `v2_final_plan.md` 的相关约束；  
   - 是否发现文档中有灰色地带（如有，请指出）。

---

## 6. 任务顺序与变更约定

- **默认情况：**
  - IDE 应按本任务表中 `P0-1 → P0-25 → P1-1 → …` 的顺序执行；
  - 不要跨级跳任务（例如 P0-10 未完成就做 P0-16）。

- **如需变更顺序或拆分任务：**
  1. IDE 必须先提出变更理由（例如：发现某个依赖不合理、拆分更安全等）；  
  2. 由我确认后，在这份任务表中更新编号/顺序（视为新版本）；  
  3. 只有任务表更新后，IDE 才能按新的顺序执行。

- 在没有我明确确认前，**不要擅自增加“隐形任务”或更改现有任务的定义。**