# YouTube 自动字幕工具 – 项目蓝图 v1.0

> 说明：
> - 本文是“高层设计蓝图”，负责说明目标、场景、模块划分和整体思路。
> - 具体行为和红线（Dry Run、增量、输出结构、翻译/摘要策略等）以 `v2_final_plan.md` 为最终标准。
> - 如两者有出入，以 `v2_final_plan.md` 为准，并通过更新本蓝图同步。

---

## 一、项目定位 & 非目标

### 1.1 项目一句话介绍

> **输入：一堆 YouTube 链接（频道 / 播放列表 / URL 列表）  
> 输出：翻译好的字幕 + AI 摘要，按统一结构整理好的“成品资料夹”，中间尽量少人工干预。**

### 1.2 使用场景（真实用法）

- 场景 A：**整个频道一次性吃完**
  - 贴频道 URL → 工具自动：
    - 扫描所有视频
    - 找出有字幕的 / 可处理的
    - 下载 → 翻译 → AI 摘要 → 按频道/视频整理输出

- 场景 B：**几个月后频道更新**
  - 再次贴同一个频道 URL → 工具只处理**新增视频**（增量处理）

- 场景 C：**手头有一堆零散链接**
  - 在 URL 列表模式中粘贴多行视频 URL → 一键批量处理 → 输出统一结构结果

> 说明：  
> - “URL 列表模式”的底层能力（批量 URL 处理）属于 P0 范畴；  
> - 独立的 GUI「URL 列表模式」页面属于 P1（在第 3.2 节定义）。

### 1.3 非目标（明确不做什么）

- 不做视频下载和转码（只处理字幕文本及衍生内容：翻译、摘要、整理）。
- 不做复杂商业化功能（多用户、多角色、Web 后台、团队协作等）。
- 不做花哨 UI 动画、复杂图表仪表盘。
- 不做泛用型“工作流编排器”，主打“一键自动跑到底”的流水线。

---

## 二、核心设计原则

1. **自动化优先**
   - 初次配置后，日常使用尽量只需要：贴链接 + 点开始。

2. **稳定性优先于功能数量**
   - 能稳定处理 1000+ 视频，比多几个选项更重要。

3. **性能优先但有护栏**
   - 支持高并发、多代理，但默认配置保守；
   - 不在代码里写死上限，以提示/日志方式提醒风险。

4. **结构清晰、易维护**
   - 业务模块：抓取 / 检测 / 下载 / 翻译 / 摘要 / 输出 / 配置 分层拆分；
   - 配置、日志、增量记录与输出结果目录分离。

5. **现代但清爽的 UI**
   - 布局参考 Clash Verge：顶部工具栏 + 左侧侧边栏 + 中间主区 + 底部日志；
   - 控件简洁、扁平，不做重度自绘和复杂效果。

---

## 三、核心功能蓝图（按优先级）

> P0：MVP 必须有的功能  
> P1：MVP 之后的首批增强  
> P2：用着爽了再说

### 3.1 P0 功能（MVP）

1. **链接输入与解析**
   - 支持输入：
     - 单个频道 URL
     - 单个播放列表 URL
     - **多行视频 URL 列表**（底层能力：核心模块 / CLI 层就应支持）。
   - 自动识别 URL 类型（频道 / 播放列表 / 单视频），统一转换成视频 ID 列表。

   > 说明：  
   > - 多行 URL 列表的**底层能力**属于 P0；  
   > - 独立的 GUI「URL 列表模式」页面归为 P1（见 3.2）。

2. **字幕检测（人工 / 自动区分）**
   - 对每个视频，检测：
     - 是否存在字幕；
     - 人工字幕语言列表；
     - 自动字幕语言列表（auto-generated）。
   - 输出统一结构的 `DetectionResult`。

3. **Dry Run（仅检测模式）**
   - 只跑到字幕检测这一步：
     - 不下载字幕；
     - 不调用任何翻译或 AI 摘要；
     - 不产生任何额外输出文件；
     - **不更新增量记录 / archives**；
   - 检测结果在日志中输出（CLI / GUI 底部日志框）。

4. **增量处理（频道 / 播放列表 / URL 列表）**
   - 针对**频道、播放列表以及 URL 列表输入**：
     - 首次：处理所有可处理的视频；
     - 后续：默认**只处理未成功处理过的视频**。
   - 使用 `yt-dlp --download-archive` 或用户数据目录中的 `archives/<channel_id>.txt` 等结构记录已处理视频 ID。
   - 增量策略采用**方案 B**：
     - 有一份全局“已成功处理的视频集合”；
     - 默认使用增量跳过历史成功视频；
     - 有 `force` 开关可忽略增量，强制重跑。

5. **字幕下载**
   - 根据检测结果：
     - 下载原始字幕（原语言）；
     - 下载官方翻译字幕（如果存在目标语言）。
   - 支持多字幕轨道（不同语言）。

6. **字幕翻译（AI / 官方翻译结合）**
   - 使用 `LanguageConfig` 统一管理：
     - 目标字幕语言列表（初期可以 UI 只暴露一个主目标语言）；
     - 翻译策略（AI_ONLY / OFFICIAL_AUTO_THEN_AI / OFFICIAL_ONLY）。
   - 策略：
     - 有官方字幕/自动翻译时优先使用；
     - 无官方可用时根据策略决定是否调用 AI 翻译；
     - 避免对同一视频+语言重复调用 AI（存在 `translated.<lang>.srt` 且未启用强制重译时不再翻译）。

7. **AI 摘要（单语言）**
   - 对字幕文本调用大模型生成摘要。
   - 摘要语言通过 `LanguageConfig.summary_language` 指定：
     - 可以与 UI 语言不同；
     - 不写死为中文。
   - Prompt 模板集中管理，使用占位符注入语言名称等。

8. **统一输出目录结构**
   - 输出结构稳定，使用语言代码命名，例如：
     - `original.en.srt`
     - `translated.zh-CN.srt`
     - `summary.en-US.md`
   - 不在目录名/文件名中写“中文/英文”等自然语言。
   - 详见 `v2_final_plan.md` 中的目录结构定义。

9. **并发执行 + 多代理 + Cookie**
   - 支持：
     - 配置并发数（默认 3，允许用户修改，不写死上限，只提示风险）；
     - 配置多个代理（数量不在代码硬限制，推荐 1–5 个，更多由用户自担风险）；
     - 粘贴 Cookie / 清空 / 测试。
   - 提供一个简单的代理健康策略：
     - 连续失败若干次即暂时标记为不健康，稍后再试。

10. **失败记录 & 日志**
    - 全局 `failed.txt`：
      - 位于 `out/` 根目录；
      - 以追加方式记录失败的视频 ID / URL / 原因。
    - 日志系统：
      - 支持写入日志文件（用户数据目录下）；
      - 显示到 CLI / GUI 底部日志框。

11. **配置自动保存**
    - 所有可配置项（并发、代理列表、Cookie、LanguageConfig、输出路径等）保存在用户数据目录的 `config.json` 中；
    - 启动时加载配置，不要求每次打开应用都重新设置。

12. **中英双语 UI + 4 套主题**
    - UI 文案支持中文 / 英文切换；
    - 双语 UI 使用 i18n 机制实现，不在界面代码里硬编码文本；
    - 主题：
      - 亮色（白）
      - 浅灰
      - 深灰
      - Claude 暖色
    - 主题实现通过主题 token，而不是散落的颜色常量。

13. **CLI 入口 + 最小 smoke test**
    - 提供命令行入口：
      - 示例语义：
        - `channel --url <channel_url> --dry-run`
        - `channel --url <channel_url> --run`
        - `urls --file urls.txt`
      - 实际命令名可以是 `python cli.py ...` 或打包后的可执行文件名，语义保持一致即可。
    - 提供一个可运行的 smoke test：
      - 处理一个小频道 / 少量 URL；
      - 自动检查输出目录结构和基本文件存在性。

### 3.2 P1 功能（增强）

1. **双语字幕（可选）**
   - 在输出中额外生成：
     - `bilingual.<source>-<target>.srt`
   - 格式可为一行中包含源语言 + 目标语言。

2. **URL 列表模式（GUI 页面）**
   - 在 UI 中提供一个专门的“URL 列表模式”页面：
     - 粘贴多行 URL；
     - 设置语言等参数；
     - 一键处理。
   - 底层使用 P0 中已经存在的“批量 URL 处理能力”。

3. **增量高级选项**
   - 支持：
     - “全量重跑某个频道/列表”的操作；
     - 对某个频道清空其 archives；
   - 需要二次确认，以避免误操作。

4. **错误分类与重试策略**
   - 对网络错误、没有字幕、AI 限流等进行分类；
   - 日志中记录更明确的错误类型；
   - 提供可配置的重试次数。

5. **进度细化 & 粗略 ETA**
   - 总进度条 + 成功/失败数量；
   - 可选：基于平均处理时间估算剩余时间，展示为“预计剩余 X 分钟（仅供参考）”。

6. **高级日志视图**
   - 日志级别过滤（INFO / WARN / ERROR / ALL）；
   - 自动滚动开关（允许暂时停留在旧日志位置）。

7. **配置导入 / 导出**
   - 导出当前配置为 JSON；
   - 导入 JSON 覆盖当前配置（需要确认）。

### 3.3 P2 功能（未来可选）

- 多语言摘要（同一视频生成多种语言的摘要文件）。
- 更多 UI 语言（例如日语、西班牙语等）。
- 简单统计/报表（每频道处理总视频数、总字符数、处理耗时等）。

---

## 四、关键技术设计

### 4.1 数据流（从输入到输出）

```text
输入（频道 URL / 播放列表 URL / URL 列表）
  ↓
VideoFetcher：解析出视频列表（VideoInfo 列表）
  ↓
IncrementalManager：过滤已成功处理的视频（增量处理）
  ↓
SubtitleDetector：检测字幕（人工/自动 + 语言）
  ↓
SubtitleDownloader：下载所需字幕轨
  ↓
SubtitleTranslator：根据策略调用 AI / 官方翻译生成目标字幕
  ↓
Summarizer：调用 AI 生成摘要（单语言）
  ↓
OutputWriter：按统一结构写出文件和目录
  ↓
IncrementalManager：更新增量记录 + FailureLogger：写 failed.txt
4.2 核心模块划分
VideoFetcher

解析频道 / 播放列表 / 单视频 / URL 列表；

调用 yt-dlp 或等效工具获取视频 ID / 元信息。

IncrementalManager

在用户数据目录下维护 archives/；

使用 archives/<channel_id>.txt 或全局索引记录“已成功处理”的视频；

提供：

判断某个 video_id 是否已成功处理；

在完整成功处理后更新记录。

SubtitleDetector

对单个视频查询所有字幕轨；

输出：有无字幕、人工/自动字幕语言列表。

SubtitleDownloader

下载指定语言 / 指定轨道的字幕；

负责与 yt-dlp 等工具交互获取具体文件。

SubtitleTranslator

根据 LanguageConfig.translation_strategy 和字幕检测结果：

决定是否调用 AI 翻译；

负责避免重复调用 AI（检查是否存在 translated.<lang>.srt 且未启用强制重译）。

Summarizer

调用大模型生成摘要；

使用 summary_language 和对应语言字幕作为输入；

Prompt 模板集中在 prompts.py。

OutputWriter

封装所有目录、文件创建逻辑；

保证输出结构稳定、命名遵循规范。

ConfigManager

读取/写入用户数据目录下的 config.json；

提供类型安全的配置对象（包括 LanguageConfig）。

TaskRunner（并发执行器）

负责队列调度与并发执行；

支持设定并发数；

与代理轮询逻辑协作。

Logger

统一写日志到文件 + 输出到控制台 / GUI；

提供不同日志级别。

4.3 LanguageConfig 再强调一次
关键点：

所有与语言相关的行为（UI、翻译、摘要、双语字幕）必须从 LanguageConfig 获取；

不允许在业务代码中出现硬编码语言的逻辑判断。

五、UI 蓝图（现代但清爽）
UI 总体结构单独在 ui_plan.md 中详细规定，这里只放核心要点。

5.1 布局骨架
顶部工具栏（全局）

左侧侧边栏（导航）

中间主内容区（随页面切换）

底部日志框（全局共享）

5.2 侧边栏主要入口
主流程

频道模式

URL 列表模式（P1）

运行设置

运行参数（并发、重试）

网络 & AI（代理、Cookie、AI 模型）

外观 & 系统

外观与语言（主题 / UI 语言）

系统与工具（打开输出/配置目录、重置等）

详细布局、控件和交互见 ui_plan.md。

六、运行方式 & 部署
6.1 CLI 模式
支持以命令行方式调用，便于批处理和自动化。

示例语义（命令名仅为示例，具体名称可根据实现调整）：

channel --url <channel_url> --dry-run

channel --url <channel_url> --run

urls --file urls.txt

实际可能表现为：

python cli.py channel --url ...

或打包后的可执行文件：yt-subtitle-v2 channel --url ...

6.2 GUI 模式
适合日常手动使用：

贴链接 + 点按钮 + 观察日志；

支持基本配置修改。

6.3 部署方式
初期：

Python + virtualenv 运行；

稳定后：

可考虑使用 PyInstaller / Nuitka 等打包为单文件 EXE / AppImage / macOS AppBundle。

七、开发阶段建议（配合 IDE 任务表使用）
建议开发节奏（与 ide_任务表.md 对应）：

阶段 1：骨架 & 配置 & 日志

建立目录结构；

实现 ConfigManager（用户数据目录）；

实现 Logger（文件 + 控制台）。

阶段 2：核心闭环（无并发，CLI）

实现 VideoFetcher / SubtitleDetector / SubtitleDownloader / SubtitleTranslator / Summarizer / OutputWriter；

先支持单线程，从 URL 到输出目录的最小闭环。

阶段 3：Dry Run + 增量 + failed.txt

实现 Dry Run（严格遵守“不下载、不翻译、不更新增量”）；

接入 IncrementalManager（实现方案 B：增量 + force）；

实现失败记录到 failed.txt。

阶段 4：并发 + 代理 + Cookie

引入 TaskRunner；

接入代理轮询 + 简易健康管理；

实现 Cookie 测试逻辑。

阶段 5：GUI 骨架 + 主流程接入

按 ui_plan.md 搭一个最小 GUI；

把核心流水线接入 GUI 主流程页面；

把 ConfigManager 接入 GUI（加载 & 保存配置）。

阶段 6：P1 功能增强

双语字幕、URL 列表模式页面、增量高级选项、日志过滤、（可选）ETA 等。

阶段 7：打包 & 测试固化

完善 smoke test；

准备打包脚本/配置；

对典型频道/URL 列表进行回归测试。

八、一句话总结
这不是一个“什么都能做一点”的工具，而是一个只干一件事，但要干到极致稳定和极致省心的 YouTube 字幕加工机：

自动吃频道 / 列表 / URL 列表；

自动检测字幕、自动翻译、自动摘要；

自动整理成结构化资料夹；

一切以“稳定+自动化+可扩展语言”优先，而不是堆功能。