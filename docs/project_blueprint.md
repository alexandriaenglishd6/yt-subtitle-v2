# YouTube 自动字幕工具 – 项目蓝图 v3.1

> 说明：
> - 本文是“高层设计蓝图”，负责说明目标、场景、模块划分和整体思路。
> - 具体行为和红线（Dry Run、增量、输出结构、翻译/摘要策略等）以 `v2_final_plan.md` 为最终标准。
> - v3.1 版本引入了分阶段流水线架构和完全国际化支持。

---

## 一、项目定位 & 非目标

### 1.1 项目一句话介绍

> **输入：一堆 YouTube 链接（频道 / 播放列表 / URL 列表）  
> 输出：翻译好的字幕 + AI 摘要，按统一结构整理好的“成品资料夹”，中间尽量少人工干预。**

### 1.2 使用场景（真实用法）

- 场景 A：**整个频道一次性吃完**
  - 贴频道 URL → 工具自动：
    - 扫描所有视频
    - 找出有字幕的 / 可处理的
    - 下载 → 翻译 → AI 摘要 → 按频道/视频整理输出

- 场景 B：**几个月后频道更新**
  - 再次贴同一个频道 URL → 工具只处理**新增视频**（增量处理）

- 场景 C：**手头有一堆零散链接**
  - 在 URL 列表模式中粘贴多行视频 URL → 一键批量处理 → 输出统一结构结果

### 1.3 非目标（明确不做什么）

- 不做视频下载和转码（只处理字幕文本及衍生内容：翻译、摘要、整理）。
- 不做复杂商业化功能（多用户、多角色、Web 后台、团队协作等）。
- 不做花哨 UI 动画、复杂图表仪表盘。
- 不做泛用型“工作流编排器”，主打“一键自动跑到底”的流水线。

---

## 二、核心设计原则

1. **自动化优先**
   - 初次配置后，日常使用尽量只需要：贴链接 + 点开始。

2. **稳定性优先于功能数量**
   - 能稳定处理 1000+ 视频，比多几个选项更重要。

3. **性能优先但有护栏**
   - 支持高并发、多代理，但默认配置保守；
   - 不在代码里写死上限，以提示/日志方式提醒风险。

4. **结构清晰、易维护**
   - 业务模块：抓取 / 检测 / 下载 / 翻译 / 摘要 / 输出 / 配置 分层拆分；
   - 配置、日志、增量记录与输出结果目录分离。

5. **现代但清爽的 UI**
   - 布局参考 Clash Verge：顶部工具栏 + 左侧侧边栏 + 中间主区 + 底部日志；
   - 控件简洁、扁平，不做重度自绘和复杂效果。

---

## 三、核心功能蓝图（按优先级）

> P0：MVP 必须有的功能  
> P1：MVP 之后的首批增强  
> P2：用着爽了再说

### 3.1 P0 功能（MVP）

1. **链接输入与解析**
   - 支持输入：
     - 单个频道 URL
     - 单个播放列表 URL
     - **多行视频 URL 列表**。
   - 自动识别 URL 类型（频道 / 播放列表 / 单视频），统一转换成视频 ID 列表。

2. **字幕检测（人工 / 自动区分）**
   - 对每个视频，检测：
     - 是否存在字幕；
     - 人工字幕语言列表；
     - 自动字幕语言列表（auto-generated）。

3. **Dry Run（仅检测模式）**
   - 只跑到字幕检测这一步，不更新增量记录，不产生输出。

4. **增量处理**
   - 默认只处理未成功处理过的视频。
   - 有 `force` 开关可忽略增量，强制重跑。

5. **字幕下载**
   - 下载原始字幕和官方翻译字幕。

6. **字幕翻译**
   - 支持 AI 翻译（OpenAI, Anthropic 等）与官方翻译。

7. **AI 摘要（单语言）**
   - 对字幕文本调用大模型生成摘要。

8. **统一输出目录结构**
   - 输出结构稳定，使用语言代码命名。

9. **并发执行 + 多代理 + Cookie**
   - 支持多并发、代理轮询和 Cookie 测试。

### 3.2 P1 功能（增强）

1. **双语字幕**
   - 生成 `bilingual.<source>-<target>.srt` 对照字幕。

2. **URL 列表模式 (GUI)**
   - 专门的 URL 粘贴与批量处理页面。

3. **错误分类与重试策略**
   - 明确错误原因，支持可配置重试。

4. **完全国际化 (v3.1)**
   - UI 和日志的完全中英文支持。

---

## 四、关键技术设计 (v3.1)

### 4.1 数据流与分阶段流水线

v3.1 引入了分阶段流水线（Staged Pipeline），每个视频的处理被分解为五个独立阶段：

```text
1. DETECT (检测)   -> 获取字幕信息
2. DOWNLOAD (下载) -> 下载原始/官方字幕
3. TRANSLATE (翻译)-> AI 翻译
4. SUMMARIZE (摘要)-> AI 摘要
5. OUTPUT (输出)   -> 写入最终文件
```

每个阶段拥有独立的线程池和输入队列，支持高度并发且互不干扰。

### 4.2 核心模块划分 (v3.1 包结构)

#### core/ai_providers/
AI 客户端实现层，统一封装不同供应商的 API 调用。
- `openai_compatible.py`: OpenAI 及兼容接口
- `anthropic.py`: Claude 原生接口
- `gemini.py`: Google Gemini 原生接口
- `google_translate.py`: 免费 Google 翻译集成
- `local_model.py`: 本地模型 (Ollama/LM Studio) 路由

#### core/staged_pipeline/
分阶段流水线引擎，负责各阶段的并发调度与数据流转。
- `scheduler.py`: 总体流水线编排
- `queue.py`: 阶段队列管理
- `processors/`: 各阶段具体业务逻辑处理器

#### core/output/
输出模块，负责文件格式转换与原子化写入。
- `writer.py`: 主写入器
- `formats/`: 字幕、摘要、元数据格式化逻辑

#### ui/
GUI 实现层，采用页面与组件分离的模块化设计。
- `main_window/`: 主窗口布局与页面切换
- `pages/`: 独立功能页面 (频道模式、运行参数、网络 AI 等)
- `components/`: 通用 UI 组件 (日志面板、侧边栏等)
- `i18n/`: 国际化资源文件

---

## 五、运行方式 & 部署

### 5.1 CLI 模式
支持以命令行方式调用，便于批处理和自动化。
`python cli.py channel --url ... --run`

### 5.2 GUI 模式
现代化 CustomTkinter 界面，适合日常手动使用。

---

## 六、总结
yt-subtitle-v3.1 是一款极致稳定、极致省心的 YouTube 字幕加工机。通过模块化重构和分阶段流水线，它能够高效、可靠地处理大规模视频任务。
