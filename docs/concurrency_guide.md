# 并发控制指南

## 概述

本工具支持并发处理多个视频任务，以提高处理效率。默认并发数为 **10**，可在 GUI 的"运行参数"页面中调整（范围：1-50）。

## 并发数设置

### 推荐值

- **1-5**：适合网络环境不稳定或需要稳定性的场景
- **6-10**：默认推荐值，平衡效率和稳定性
- **11-20**：适合网络环境良好、需要较高处理速度的场景
- **21-30**：高风险，可能导致限流或错误
- **31-50**：极高风险，不推荐使用

### 调整方法

1. 打开 GUI，进入"运行设置" → "运行参数"
2. 使用滑块或直接输入数值（范围：1-50）
3. 点击"保存设置"应用更改

## 高并发风险

### 1. 网络限流（Rate Limiting）

**风险描述：**
- YouTube API 和 yt-dlp 对请求频率有限制
- 高并发可能导致：
  - **429 Too Many Requests** 错误
  - IP 地址临时封锁
  - 需要等待较长时间才能恢复

**建议：**
- 并发数超过 20 时，系统会显示警告提示
- 如果频繁遇到 429 错误，建议降低并发数
- 使用代理可以分散请求，但每个代理也有独立限流

### 2. 本地模型压力

**风险描述：**
- 如果使用本地 AI 模型（如本地部署的 LLM）：
  - 高并发会同时发起多个 AI 请求
  - 可能导致：
    - 内存占用过高
    - GPU/CPU 资源耗尽
    - 模型响应变慢或崩溃

**建议：**
- 本地模型用户建议并发数不超过 5
- 监控系统资源使用情况
- 使用 `max_concurrency` 参数限制 AI 并发（在 AI 配置中设置）

### 3. Cookie 和代理限制

**风险描述：**
- 即使配置了 Cookie 和代理，高并发仍可能导致：
  - Cookie 失效（频繁请求触发验证）
  - 代理 IP 被封禁
  - 代理服务器过载

**建议：**
- 使用多个代理时，确保代理池足够大
- 监控代理健康状态
- 避免在短时间内发起过多请求

## 最佳实践

### 1. 渐进式调整

- 从默认值（10）开始
- 如果网络稳定且无错误，可以逐步增加
- 如果出现错误，立即降低并发数

### 2. 监控日志

- 关注日志中的错误信息：
  - `429 Too Many Requests`
  - `Connection timeout`
  - `Rate limit exceeded`
- 如果频繁出现这些错误，降低并发数

### 3. 结合 AI 并发限制

- 在 AI 配置中设置 `max_concurrency`（默认 5）
- 这可以限制同时进行的 AI 请求数量
- 即使下载并发数较高，AI 请求也会被限流

### 4. 使用代理

- 配置多个代理可以分散请求
- 每个代理有独立的限流限制
- 确保代理池足够大（建议至少 3-5 个）

## 故障排查

### 问题：频繁出现 429 错误

**解决方案：**
1. 降低并发数到 5 以下
2. 等待一段时间后重试
3. 检查 Cookie 是否有效
4. 考虑使用代理

### 问题：本地模型响应变慢

**解决方案：**
1. 降低并发数到 5 以下
2. 在 AI 配置中降低 `max_concurrency`
3. 检查系统资源（内存、CPU、GPU）
4. 考虑使用云端 AI 服务

### 问题：代理 IP 被封禁

**解决方案：**
1. 降低并发数
2. 增加代理池大小
3. 使用更高质量的代理服务
4. 避免在短时间内发起过多请求

## 技术细节

### 并发实现

- 使用 `ThreadPoolExecutor` 实现并发
- 每个视频任务在独立线程中执行
- 下载、翻译、摘要等步骤按顺序执行

### AI 并发限制

- AI 请求使用独立的并发限制（`max_concurrency`）
- 即使下载并发数为 10，AI 并发数可能只有 5
- 这确保了 AI 请求不会过载

### 错误处理

- 网络错误会自动重试（可配置重试次数）
- 429 错误会等待后重试
- 永久性错误会记录到失败日志

## 相关配置

- **并发数**：`config.json` 中的 `concurrency` 字段
- **重试次数**：`config.json` 中的 `retry_count` 字段
- **AI 并发限制**：`config.json` 中的 `translation_ai.max_concurrency` 和 `summary_ai.max_concurrency`

## 总结

并发控制是平衡效率和稳定性的关键。建议：

1. **从默认值开始**：使用默认并发数（10）
2. **根据实际情况调整**：根据网络环境和错误情况调整
3. **监控和日志**：关注日志中的错误信息
4. **结合其他配置**：合理配置代理、Cookie 和 AI 并发限制

如有问题，请查看日志文件或联系技术支持。

