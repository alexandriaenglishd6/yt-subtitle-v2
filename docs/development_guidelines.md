# 开发规范与注意事项

> 本文档从 `v2_high_concurrency_plan.md` 拆分出来，汇总所有开发规范和注意事项。
> 
> **重要**：开发过程中请随时参考本文档，避免常见问题。

---

## 🔴 高危（必须注意）

| 序号 | 事项 | 风险 | 预防措施 |
|------|------|------|----------|
| 1 | **所有资源池必须加锁** | 数据混乱、崩溃 | 使用 `with self.lock:` |
| 2 | **不要在锁内做耗时操作** | 性能下降、死锁 | 锁内只做取值，不调 API |
| 3 | **每个 try-except 都要记录日志** | 问题无法追踪 | `logger.error(f"错误: {e}")` |
| 4 | **API Key 不要硬编码** | 泄露风险 | 存配置文件或环境变量 |
| 5 | **测试时先用小并发** | 大并发问题难定位 | 先 3 并发，稳定后再加 |

---

## 🟡 中危（容易疏忽）

| 序号 | 事项 | 风险 | 预防措施 |
|------|------|------|----------|
| 6 | **Cookie/代理失效判断要准确** | 好资源被误禁 | 多观察日志，逐步调整 |
| 7 | **不同 Provider 响应格式不同** | 解析失败 | 统一封装 `extract_result()` |
| 8 | **冷却时间设置要合理** | 太短失效，太长浪费 | Cookie 60s，代理 5min |
| 9 | **限流和失效要区分处理** | 处理策略不同 | 限流暂停，失效换资源 |
| 10 | **进度统计要线程安全** | 数字不准 | 用 `threading.Lock` 保护 |

---

## 🟢 低危（优化建议）

| 序号 | 事项 | 影响 | 建议 |
|------|------|------|------|
| 11 | **日志级别区分** | 高并发时日志爆炸 | DEBUG/INFO/WARNING 分开 |
| 12 | **配置热更新** | 改配置要重启 | 可选，后续优化 |
| 13 | **内存监控** | 长时间运行内存泄漏 | 定期检查，可选 |
| 14 | **优雅停止** | 强制停止丢失进度 | 处理 SIGINT 信号 |
| 15 | **单元测试覆盖** | 改代码容易出 bug | 关键模块写测试 |

---

## 🌍 国际化规范

| 规范 | 说明 | 示例 |
|------|------|------|
| **UI 文本禁止硬编码** | 必须用 `t('key')` | `t('download_complete')` |
| **日志消息国际化** | 日志也要多语言 | `logger.info(t('log_translate_start'))` |
| **错误提示国际化** | 用户可见的错误 | `t('error_api_limit')` |
| **时间格式本地化** | 不同地区格式不同 | 中文: 2025年1月1日 |
| **数字格式本地化** | 千分位符号不同 | 中文: 1,000 |
| **语言文件独立** | 便于翻译 | `locales/zh_CN.json` |

### 添加新语言步骤

> 架构已设计完善，扩展语言**无需改代码**

| 步骤 | 操作 | 工作量 |
|------|------|--------|
| 1 | 复制 `core/i18n/locales/en_US.json` → `ja_JP.json` | 1 分钟 |
| 2 | 翻译所有键值 | 2-4 小时 |
| 3 | 在 UI 配置中添加语言选项 | 5 分钟 |

### 当前支持语言

| 语言 | 文件 | 状态 |
|------|------|------|
| 中文 | `zh_CN.json` | ✅ 完成 |
| 英文 | `en_US.json` | ✅ 完成 |
| 日文 | `ja_JP.json` | ⏳ 待添加 |
| 韩文 | `ko_KR.json` | ⏳ 待添加 |

### 架构说明

```
core/i18n/
├── __init__.py          # t() 函数入口
├── provider.py          # Provider 基类
├── json_provider.py     # JSON 文件加载
└── locales/
    ├── en_US.json       # 英文
    └── zh_CN.json       # 中文
```

**日志跟随当前语言**：所有 `t()` 调用自动使用当前选择的语言。

---

## 📁 文件路径规范

| 规范 | 说明 |
|------|------|
| **使用 Path** | 不用字符串拼接 |
| **相对路径** | 便于移植 |
| **中文路径兼容** | Windows 中文用户名 |
| **路径分隔符** | 用 `/` 或 `Path`，不用 `\` |

---

## 🔧 配置管理规范

| 规范 | 说明 |
|------|------|
| **默认值兜底** | 配置缺失不崩溃 |
| **配置校验** | 启动时检查必填项 |
| **敏感信息分离** | API Key 单独文件 |
| **版本迁移** | 旧版配置自动升级 |

---

## 📊 性能规范

| 规范 | 说明 |
|------|------|
| **大文件分块读取** | 不要一次性读入内存 |
| **结果及时释放** | 处理完释放内存 |
| **定时器及时取消** | 避免内存泄漏 |
| **线程池复用** | 不要每次创建新线程池 |

---

## 🔒 安全规范

| 规范 | 说明 |
|------|------|
| **不记录敏感信息** | 日志不打印完整 API Key |
| **临时文件及时删除** | 不留垃圾 |
| **输入校验** | 防止路径注入 |
| **HTTPS 优先** | API 调用用 HTTPS |

---

## 📝 代码规范

| 规范 | 说明 |
|------|------|
| 函数不超过 50 行 | 太长拆分 |
| 一个文件不超过 300 行 | 太长拆模块 |
| 变量名要有意义 | `proxy` 不要写成 `p` |
| 复杂逻辑加注释 | 让 AI 也能理解 |

---

## ✅ 上线前检查清单

| 检查项 | 状态 |
|--------|------|
| ☐ 所有 API Key 已配置 |
| ☐ Cookie 文件已放置 |
| ☐ 代理列表已配置 |
| ☐ 日志目录有写权限 |
| ☐ 小规模测试通过 |
| ☐ 10 并发测试通过 |
| ☐ 30 并发测试通过 |
| ☐ 国际化文本完整 |

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [v2_high_concurrency_plan.md](./v2_high_concurrency_plan.md) | v2.0 总体规划 |
| [dev_workflow_guide.md](./dev_workflow_guide.md) | 开发工作流指南 |
| [PROJECT_CONTEXT.md](./PROJECT_CONTEXT.md) | 项目上下文 |
