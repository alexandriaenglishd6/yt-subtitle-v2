# IDE 集成与行为约束（ide_integration.md）

> 面向对象：所有 AI / IDE / 开发助手  
> 目的：约束开发行为，保证实现严格遵守项目文档，同时说明**如何正确参考旧项目代码**而不把技术债带进 V2。

---

## 1. 角色与文档优先级

本项目中，IDE / AI 的角色是：**“按文档施工的高级工具”**，而不是作者或产品经理。

必须遵守以下文档优先级（从高到低）：

1. `docs/v2_final_plan.md` – 行为规范（Dry Run / 增量 / 输出结构 / LanguageConfig / 并发 & 代理 等）  
2. `docs/ide_任务表.md` – 任务清单与执行顺序  
3. `docs/project_blueprint.md` – 项目蓝图（目标、场景、架构）  
4. `docs/ui_plan.md` – UI 布局与交互规划  
5. `docs/acceptance_criteria.md` – 验收标准  
6. 本文件 `docs/ide_integration.md` – IDE 行为约束

> **当任何两份文档出现冲突时：**  
> - 行为语义 → 以 `docs/v2_final_plan.md` 为准；  
> - 任务顺序 → 以 `docs/ide_任务表.md` 为准；  
> - UI 布局 → 以 `docs/ui_plan.md` 为准。  
> IDE 不得自行“拍板”，必须先让用户调整文档，再修改代码。

---

## 2. IDE 必须做的事情（MUST）

### 2.1 开工前

1. **通读核心文档**  
   - 至少阅读并理解：  
     - `docs/v2_final_plan.md`  
     - `docs/ide_任务表.md`  
     - `docs/project_blueprint.md`  
   - 如要改 UI，还应阅读 `docs/ui_plan.md`。  
   - 如要提交阶段成果，要对照 `docs/acceptance_criteria.md` 自检。

2. **声明当前任务编号**  
   - 明确写出：  
     - 「当前执行任务：P0-7 字幕检测（单视频）」  
   - 以便用户知道你在执行哪一条。

3. **复述任务理解（简短中文）**  
   - 「我理解本任务目标是：……」  
   - 「需要新增 / 修改的文件大概是：……」  
   - 「不会动哪些已经稳定的模块：……」

4. **列出执行步骤草案**  
   - 例如：  
     - 步骤 1：在 `core/xxx.py` 创建 XXX 类  
     - 步骤 2：在 `cli.py` 接线一个新命令  
     - 步骤 3：编写简单测试 / 用例  
   - 用户可以基于此调整你的计划。

---

### 2.2 提交修改后

每次完成一个任务或一轮改动，必须：

1. **列出修改文件清单**  
   - 例如：  
     - 修改：`core/pipeline.py`、`core/downloader.py`  
     - 新增：`core/subtitle_detector.py`  
     - 删除或废弃：如有，说明原因。

2. **解释行为变化**  
   - 说明现在的行为：  
     - 输入什么 → 程序做了哪些事情 → 输出是什么；  
   - 指出与 `docs/v2_final_plan.md` 对应的小节：  
     - 「增量逻辑实现参考了 X 小节」  
     - 「Dry Run 严格遵守了 Y 小节的禁止列表」

3. **给出用户可复现的验收步骤**  
   - 命令行或 GUI 步骤，如：  
     - `python cli.py channel --url <测试频道> --dry-run`  
     - 打开 `out/`，查看 `某个目录` 是否存在  
   - 用户不需要写代码，只会复制命令和点按钮。

4. **自评是否符合验收标准**  
   - 引用 `docs/acceptance_criteria.md` 中相关章节：  
     - 「功能行为部分：符合 / 暂不完全符合（说明差异）」  
     - 「稳定性：已在 3~5 个视频 / 50~100 视频范围测试」  
   - 如有不符合，必须主动指出，而不是“藏起来”。

---

## 3. IDE 必须避免的行为（MUST NOT）

1. **不得修改核心文档语义**  
   - 不得自作主张修改：`docs/v2_final_plan.md` / `docs/project_blueprint.md` / `docs/ide_任务表.md` / `docs/ui_plan.md` / `docs/acceptance_criteria.md`；  
   - 如认为文档有问题，必须先用人类可读的中文说明，再由用户修改文档。

2. **不得擅自改变核心行为**  
   - 不得更改 Dry Run 的语义（例如增加下载 / 报告写入 / 更新增量）；  
   - 不得擅自改变增量策略（方案 B）或 `force` 的行为；  
   - 不得更改输出目录结构 / 文件命名规则；  
   - 不得在业务逻辑中硬编码“中国 / 中文 / zh-CN”等。

3. **不得打乱任务顺序或私自新增任务**  
   - 不得跳过 `ide_任务表.md` 中前置 P0 任务，直接做后面任务；  
   - 不得添加“隐藏任务”（比如自己加一个 P0-99），除非先与用户协商并更新文档。

4. **不得搞“黑盒大重构”**  
   - 不允许“一次改十几个文件，然后一句话带过”；  
   - 不允许把多处逻辑压缩成超长函数或超大文件，导致后续难以修改；  
   - 大改结构前，必须先说明计划并获得用户确认。

5. **不得删除关键日志 / 检查**  
   - 不得为了“代码简洁”删掉对错误场景的日志打印；  
   - 不得移除 `out/failed.txt` 等关键输出；  
   - 不得删掉或弱化 smoke test。

---

## 4. 新工具如何参考旧项目代码（核心部分）

> 旧项目代码 = 已存在的 V1 工具 / 旧版仓库。  
> V2 是一个新的子项目 / 重构版本，**可以参考旧代码，但不能把旧的混乱架构原封不动搬进来**。

### 4.1 总原则：V1 仓库是“参考资料”，不是“依赖库”

- 旧项目代码的角色类似：  
  - 思路参考；  
  - 算法示例；  
  - 历史经验（有哪些坑）。  

- V2 的代码结构、模块划分、接口定义，必须以以下文档为准：  
  - `docs/project_blueprint.md`  
  - `docs/v2_final_plan.md`  
  - `docs/ui_plan.md`

**简化成一句话：**

> 可以从 V1 里“抄做法、抄算法”，但不能“抄架构、抄一整坨业务逻辑”。

---

### 4.2 允许直接复用的内容（可以复制后重命名 / 重构）

在以下情况，可以参考甚至直接复制旧项目的代码片段，但要**迁移到 V2 结构**中并按规范改名 / 改参数：

1. **纯工具函数 / 小型算法**  
   - 和具体业务无关的工具方法，例如：  
     - 时间格式化；  
     - 简单的文本清理函数；  
     - 简单的路径拼接工具（但要符合 V2 的路径设计）；  
   - 迁移后放入 V2 的 `utils` 或相关模块中。

2. **已验证有效的解析逻辑**  
   - 比如用于解析 yt-dlp 输出、判定字幕语言的逻辑；  
   - 迁移时要：  
     - 去掉旧项目中特定 UI / 控制器耦合；  
     - 把硬编码常量改成配置或枚举；  
     - 使用 V2 的数据模型（例如 `VideoInfo`、`DetectionResult`）。

3. **可复用的 Prompt 模板思想**  
   - 旧项目里对“如何写摘要 Prompt”的思路可以借鉴；  
   - 但实际 Prompt 文本必须迁移到 `core/prompts.py`，并引入参数化（不硬编码“中文”），使用 `LanguageConfig` 注入语言。

**要求：**

- 复制前：说明想复用的部分是什么，以及为什么适合复用；  
- 复制后：  
  - 放在 V2 正确的位置（例如 `core/translator.py`、`core/utils.py`）；  
  - 用 V2 的命名和类型封装；  
  - 删除/替换与旧项目耦合的部分。

---

### 4.3 只能“看思路，不能直接搬”的内容（禁止硬复制）

以下内容**禁止直接复制进 V2**，只能当成“参考思路”：

1. **旧的控制器 / GUI 代码**  
   - 如旧项目的 `Controller` + `View` 强耦合结构；  
   - 老式信号槽乱飞、业务逻辑堆在 UI 内部的部分；  
   - V2 必须按照 `docs/ui_plan.md` 的布局和模块划分重新设计 UI，不允许把旧 UI 直接搬进来再修改。

2. **旧的业务流水线 / 管线函数**  
   - 旧项目中如果有一个大函数一口气做：解析 URL → 检测 → 下载 → 翻译 → 摘要 → 输出；  
   - V2 已经在 `project_blueprint.md` 和 `v2_final_plan.md` 中明确了分层模块：  
     - `VideoFetcher` / `IncrementalManager` / `SubtitleDetector` / `SubtitleDownloader` / `SubtitleTranslator` / `Summarizer` / `OutputWriter` 等；  
   - IDE 不得直接复制 V1 的“大一坨流水线函数”，而是要按 V2 的方式拆分重写。

3. **任何带有硬编码中文 / 路径 / 特定平台假设的逻辑**  
   - 旧项目中出现的：  
     - “翻译成中文”  
     - `if lang == "zh-CN": ...`  
     - 固定路径 `C:/Users/.../某某`  
   - 这些都只能看逻辑，不能照搬；V2 必须通过 `LanguageConfig` 和配置系统来处理语言/路径。

4. **旧的增量 / Dry Run / 并发实现**  
   - V2 的增量策略、Dry Run 行为、并发/代理规则都已经在 `v2_final_plan.md` 写死；  
   - 旧项目里的实现可以参考“坑在哪里”，但**绝对不能原样复制**，以免行为与文档冲突。

---

### 4.4 从旧代码迁移逻辑时，推荐的操作流程

当 IDE 发现旧项目中有一段逻辑看起来可以复用时，应按以下步骤处理：

1. **在对话中说明意图**  
   - 例如：  
     - 「在旧项目的 `xxx.py` 中有一段用于解析字幕轨道的逻辑，看起来比较成熟，我准备按 V2 的结构重写一份，保留其核心判断规则。」  

2. **提炼“逻辑而非代码”**  
   - 用自然语言概括这段旧代码在做什么：  
     - 输入是什么；  
     - 输出是什么；  
     - 有哪些关键判断；  
   - 对照 `v2_final_plan.md` 看看逻辑是否还适用。

3. **根据 V2 规范重新设计接口**  
   - 决定这段逻辑在 V2 中应该放在哪个模块（如 `SubtitleDetector`）；  
   - 按 V2 的数据模型重新设计函数签名：  
     - 使用 `VideoInfo` / `DetectionResult` 等，而不是旧项目里随便的 dict。

4. **再开始写新代码（必要时部分复制旧代码片段）**  
   - 可以选用旧代码中的部分条件表达式 / 算法，但必须：  
     - 去掉旧项目中的依赖（UI / 控制器 / 全局状态）；  
     - 符合 V2 的风格和结构。

5. **自测 & 对比**  
   - 用一两个例子，对比 V1 和 V2 在同样输入下的行为是否一致；  
   - 如有差异，需要解释：是改进、还是 bug。

---

### 4.5 严禁行为示例

以下行为是明确禁止的：

- 直接把旧项目整个 `core/` / `gui/` 目录复制到 V2 仓库里，然后开始删删改改；
- 直接复制旧项目中的任意单个 `.py` 文件到 V2 仓库中，然后只做少量修改就当成新代码使用；如果确实需要复用旧逻辑，必须用“先理解，再按 V2 架构重写”的方式逐函数迁移，而不是整文件搬运。
- 在 V2 里保留旧项目的类名和模块结构，然后一边 patch 一边“缝合”新逻辑；
- 在 V2 的代码中使用旧项目特定的全局变量、配置路径、magic number；
- 用“兼容旧逻辑”为理由，推翻 `v2_final_plan.md` 中已经明确的规范（尤其是 Dry Run / 增量 / 目录结构 / LanguageConfig）。


---

## 5. 与用户的协作流程

### 5.1 三步沟通模式（建议）

每次准备做较大改动（尤其是涉及旧代码迁移或新模块设计）时，建议遵循：

1. **说明现状**  
   - 「目前 V2 没有 XXX 模块；旧项目中有一段实现；V2 文档中要求的行为是……」。

2. **给出两三种实现方案（含是否参考旧代码）**  
   - 方案 A：完全重写，按 V2 文档从零搭建；  
   - 方案 B：从旧项目迁移这段逻辑，重写接口和结构；  
   - 方案 C：（如有其它合理选择）。

3. **等待用户拍板**  
   - 一旦用户选择方案，例如「选 B，但要注意 XXX」，再根据该方案执行；  
   - 执行中如发现新问题，再回头沟通。

---

## 6. 变更本文件的规则

- 如需修改本文件（例如新增某条禁止行为或补充迁移准则），必须：  
  1. 由 IDE 或用户提出修改需求；  
  2. 用户确认修改内容；  
  3. 更新 `docs/ide_integration.md` 后，后续开发按新版本执行。

- IDE 不得擅自更改本文件中的约束条目，然后按修改后的版本行事。