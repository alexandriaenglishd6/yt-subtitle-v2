# 会话交接资料 - 2025-12-15

> **用途**：为新会话提供快速上手的上下文信息  
> **创建日期**：2025-12-15  
> **项目状态**：R3 任务全部完成，代码重构准备阶段

---

## 📋 目录

1. [项目概览](#1-项目概览)
2. [当前任务状态](#2-当前任务状态)
3. [今天完成的工作（2025-12-15）](#3-今天完成的工作2025-12-15)
4. [重要文档索引](#4-重要文档索引)
5. [关键代码文件](#5-关键代码文件)
6. [待解决问题](#6-待解决问题)
7. [下一步计划](#7-下一步计划)
8. [快速上手检查清单](#8-快速上手检查清单)

---

## 1. 项目概览

### 1.1 项目名称
**YouTube 字幕工具 v2** (yt-subtitle-v2)

### 1.2 项目类型
- **CLI 工具**：支持频道、播放列表、URL 列表模式
- **GUI 应用**：基于 customtkinter 的图形界面

### 1.3 核心功能
- 视频字幕检测、下载
- AI 翻译（支持多供应商：OpenAI、Gemini、Claude、Google Translate）
- AI 摘要生成
- 双语字幕输出
- 增量管理（跳过已处理视频）
- 错误分类与失败记录
- **分阶段流水线架构**（R3-1，已完成）
- **AI Profile 配置管理**（R3-2，已完成）
- **本地模型预热**（R3-3，已完成）
- **AI 供应商健康检查**（R3-4，已完成）

### 1.4 技术栈
- **Python 3.8+**
- **customtkinter**：GUI 框架
- **yt-dlp**：视频信息获取和字幕下载
- **LLM 客户端**：OpenAI、Anthropic、Google Gemini 等（基于 `LLMClient` Protocol）

---

## 2. 当前任务状态

### 2.1 已完成任务

#### R0 红线级任务（全部完成）
- ✅ **R0-1**：重构 AI 架构 + 修复流水线 LLM 参数
- ✅ **R0-2**：调整 archive 存储位置 + 迁移旧数据
- ✅ **R0-3**：Dry Run 模式彻底只读
- ✅ **R0-4**：文件写入：加锁 + 原子写入
- ✅ **R0-5**：临时目录清理逻辑补完

#### R1 高优先级任务（全部完成）
- ✅ **R1-1**：统一 LLMException → AppException → failure_logger
- ✅ **R1-2**：任务取消机制（CancelToken）
- ✅ **R1-3**：代理健康管理与自动降级
- ✅ **R1-4**：下载并发与 AI 并发解耦 / 限速

#### R2 中期优化任务（全部完成）
- ✅ **R2-1**：结构化失败记录 `failed_records.json`
- ✅ **R2-2**：扩展 `metadata.json` 中的 AI 与运行信息
- ✅ **R2-3**：日志规范与日志滚动（轮转）
- ✅ **R2-4**：GUI 线程安全与事件流文档化
- ✅ **R2-5**：Cookie 地区测试结果缓存
- ✅ **R2-6**：并发默认值与 UI 控制优化

#### R3 长期优化任务（全部完成）
- ✅ **R3-1**：流水线分阶段队列化（Staged Pipeline）
- ✅ **R3-2**：AI Profile 配置与多供应商路由
- ✅ **R3-3**：本地模型资源限制与预热
- ✅ **R3-4**：AI 供应商健康自检脚本 `ai_smoke_test`

#### P0 任务（核心功能，全部完成）
- ✅ **P0-1 ~ P0-25**：CLI 完整流水线 + GUI 完整实现

#### P1 任务（增强功能，部分完成）
- ✅ **P1-1**：双语字幕输出功能

### 2.2 进行中的任务

#### 代码重构准备（2025-12-15）
- ✅ **Git 提交信息乱码修复**：已创建修复脚本和文档
- ✅ **重构分析文档更新**：已添加 AI 供应商接入计划和日志国际化方案
- ✅ **AI 代码分析材料准备**：已创建 `AI analysis/` 文件夹
- ✅ **日志框时间戳显示**：已完成
- ✅ **状态栏代理状态显示**：已完成

### 2.3 待完成任务

#### 代码重构（待开始）
- ⏳ **大文件拆分**：根据 AI 分析结果开始实施
  - 7 个大文件已准备在 `AI analysis/` 文件夹中
  - 等待 AI 分析结果后开始拆分

#### 功能优化（待开始）
- ⏳ **日志国际化优化**：实施日志输出的国际化方案
  - 问题：UI 已国际化但日志仍为中文
  - 方案：键值化、包装器、混合方案（详见 `docs/code_refactoring_analysis.md`）

---

## 3. 今天完成的工作（2025-12-15）

### 3.1 Git 提交信息乱码修复

**问题**：远程仓库有 3 个提交信息出现乱码

**解决方案**：
- 创建 `fix_commits_gitbash.sh` 脚本（Git Bash 环境使用）
- 创建 `docs/fix_commit_encoding.md` 和 `docs/COMMIT_ENCODING_FIX.md` 修复指南
- 提供 3 种修复方法：Git Bash 脚本、交互式 rebase、手动 rebase

**相关文件**：
- `fix_commits_gitbash.sh` - Git Bash 修复脚本
- `docs/fix_commit_encoding.md` - 提交信息编码修复指南
- `docs/COMMIT_ENCODING_FIX.md` - 最终修复指南

### 3.2 重构分析文档更新

**更新内容**：
- 在 `docs/code_refactoring_analysis.md` 中添加 **AI 供应商接入计划**章节
  - 当前支持的供应商（OpenAI 兼容、Gemini、Claude、Google Translate）
  - 接入新供应商的方案（通过 OpenAI 兼容协议或实现新客户端）
  - 本地 AI 模型优化方向
- 在 `docs/code_refactoring_analysis.md` 中添加 **日志国际化优化方案**章节
  - 问题描述：UI 已国际化但日志仍为中文
  - 三种解决方案：键值化、包装器、混合方案
  - 实施优先级和计划
- 同步更新 `docs/code_structure_analysis.md` 和 `docs/refactoring_materials_summary.md`

**相关文件**：
- `docs/code_refactoring_analysis.md` - 主要分析文档
- `docs/code_structure_analysis.md` - 详细结构分析
- `docs/refactoring_materials_summary.md` - 材料总结

### 3.3 AI 代码分析材料准备

**创建内容**：
- 创建 `AI analysis/` 文件夹，包含关键代码和文档
- 复制 7 个大文件源代码（需要拆分的文件）
- 复制 6 个分析文档
- 创建 `AI analysis/README.md` 使用说明
- 创建 `AI analysis/提示词模板.md` 包含 5 个提示词模板

**目的**：准备材料供其他 AI 进行代码分析，提出大文件拆分建议

**相关文件**：
- `AI analysis/README.md` - AI 分析材料使用说明
- `AI analysis/提示词模板.md` - AI 交互提示词模板（5个模板）

### 3.4 日志框时间戳显示功能

**实现内容**：
- 在 `ui/components/log_panel.py` 的 `append_log` 方法中添加时间戳生成
- 时间戳格式：`YYYY-MM-DD HH:MM:SS.mmm`
- 日志显示格式：`[2025-12-15 23:51:23.890] [INFO] 消息内容`
- 与控制台日志格式保持一致

**相关文件**：
- `ui/components/log_panel.py` - 日志面板组件

### 3.5 状态栏代理状态显示功能

**实现内容**：
- 在 `LogPanel` 中添加 `proxy_status` 属性和 `update_proxy_status()` 方法
- 在 `MainWindow` 中添加 `_update_proxy_status()` 方法
- 代理状态类型：
  - 未配置：无代理或代理列表为空
  - 已配置 (X个健康)：所有代理都健康
  - 已配置 (X健康/Y不健康)：部分代理不健康
  - 直连 (X个不健康)：所有代理都不健康
- 在初始化时和保存代理配置后自动更新状态
- 状态栏显示格式：`代理：已配置 (3个健康)`

**相关文件**：
- `ui/components/log_panel.py` - 日志面板组件
- `ui/main_window.py` - 主窗口

---

## 4. 重要文档索引

### 4.1 核心规范文档（必读）

| 文档路径 | 说明 | 优先级 |
|---------|------|--------|
| `docs/v2_final_plan.md` | **行为规范**（最高优先级） | ⭐⭐⭐ |
| `docs/ide_任务表.md` | 任务清单和执行顺序 | ⭐⭐⭐ |
| `docs/ide_修复任务表_AI层与流水线.md` | R 系列修复任务表 | ⭐⭐⭐ |
| `docs/ide_测试任务表.md` | 测试任务清单 | ⭐⭐⭐ |
| `docs/ide_integration.md` | IDE 行为约束 | ⭐⭐ |
| `docs/acceptance_criteria.md` | 验收标准 | ⭐⭐ |

### 4.2 开发日志和状态

| 文档路径 | 说明 | 最后更新 |
|---------|------|----------|
| `docs/dev_log.md` | **开发日志**（每日工作记录） | 2025-12-15 |
| `docs/会话交接资料_2025-12-15.md` | 会话交接资料（本文档） | 2025-12-15 |

### 4.3 架构和设计文档

| 文档路径 | 说明 |
|---------|------|
| `docs/project_blueprint.md` | 项目蓝图 |
| `docs/ai_design.md` | AI 调用设计规范 |
| `docs/AI_PROVIDER_EXTENSION.md` | AI 提供商扩展文档 |
| `docs/ui_plan.md` | UI 布局与交互设计 |
| `docs/staged_pipeline_design_review.md` | 分阶段流水线设计文档 |
| `docs/ai_profile_design.md` | AI Profile 设计文档 |
| `docs/ai_profile_usage.md` | AI Profile 使用指南 |
| `docs/local_model_warmup.md` | 本地模型预热文档 |
| `docs/ai_smoke_test_guide.md` | AI 供应商健康检查指南 |

### 4.4 代码重构分析文档

| 文档路径 | 说明 |
|---------|------|
| `docs/code_refactoring_analysis.md` | **主要分析文档**（包含 AI 供应商接入计划和日志国际化方案） |
| `docs/code_structure_analysis.md` | 详细结构分析 |
| `docs/refactoring_materials_summary.md` | 材料总结 |
| `AI analysis/README.md` | AI 分析材料使用说明 |
| `AI analysis/提示词模板.md` | AI 交互提示词模板 |

### 4.5 Git 修复文档

| 文档路径 | 说明 |
|---------|------|
| `docs/fix_commit_encoding.md` | 提交信息编码修复指南 |
| `docs/COMMIT_ENCODING_FIX.md` | 最终修复指南 |
| `fix_commits_gitbash.sh` | Git Bash 修复脚本 |

---

## 5. 关键代码文件

### 5.1 核心模块

| 文件路径 | 说明 |
|---------|------|
| `core/pipeline.py` | **核心流水线**（支持分阶段流水线和旧模式） |
| `core/staged_pipeline.py` | **分阶段流水线**（R3-1，Detect → Download → Translate → Summarize → Output） |
| `core/detector.py` | 字幕检测 |
| `core/downloader.py` | 字幕下载 |
| `core/translator.py` | AI 翻译 |
| `core/summarizer.py` | AI 摘要 |
| `core/output.py` | 输出模块（包括双语字幕） |
| `core/language.py` | 语言配置（LanguageConfig） |
| `core/llm_client.py` | LLM 客户端抽象接口（Protocol） |
| `core/ai_providers.py` | LLM 客户端实现（包含本地模型预热） |
| `core/ai_profile_manager.py` | **AI Profile 管理器**（R3-2） |

### 5.2 GUI 模块

| 文件路径 | 说明 |
|---------|------|
| `ui/main_window.py` | 主窗口（布局与事件接线，包含代理状态更新） |
| `ui/business_logic.py` | 业务逻辑（VideoProcessor，使用 AI Profile） |
| `ui/pages/channel_page.py` | 频道模式页面 |
| `ui/pages/url_list_page.py` | URL 列表模式页面 |
| `ui/components/toolbar.py` | 顶部工具栏 |
| `ui/components/sidebar.py` | 左侧导航栏 |
| `ui/components/log_panel.py` | **日志输出面板**（包含时间戳和代理状态显示） |
| `ui/fonts.py` | 字体配置（3种规格：22px/18px/14px） |
| `ui/themes.py` | 主题系统 |
| `ui/i18n_manager.py` | 国际化管理 |

### 5.3 配置管理

| 文件路径 | 说明 |
|---------|------|
| `config/manager.py` | 配置管理器（ConfigManager） |
| `config/ai_profiles.json.example` | **AI Profile 配置示例**（R3-2） |
| `cli/main.py` | CLI 入口 |
| `cli/ai_smoke_test.py` | **AI 供应商健康检查 CLI 命令**（R3-4） |

---

## 6. 待解决问题

### 6.1 代码重构相关

| 问题 | 状态 | 说明 |
|------|------|------|
| 大文件拆分 | ⏳ 待开始 | 7 个大文件已准备在 `AI analysis/` 文件夹中，等待 AI 分析结果 |
| 日志国际化优化 | ⏳ 待开始 | 方案已确定，待实施（详见 `docs/code_refactoring_analysis.md`） |

### 6.2 Git 相关

| 问题 | 状态 | 说明 |
|------|------|------|
| 提交信息乱码 | ⏳ 待修复 | 已创建修复脚本和文档，需要在 Git Bash 环境中执行 |

### 6.3 功能限制

| 功能 | 状态 | 说明 |
|------|------|------|
| 下拉框内部翻页按钮 | ⏸️ 已搁置 | customtkinter 限制，需要完全自定义组件 |
| TXT 字幕格式 | ⏳ 未开始 | 待实施（`需求分析与实施方案.md` 需求3） |

---

## 7. 下一步计划

### 7.1 短期计划（优先级高）

1. **修复 Git 提交信息乱码**
   - 在 Git Bash 环境中执行 `fix_commits_gitbash.sh` 脚本
   - 或按照 `docs/COMMIT_ENCODING_FIX.md` 中的指南手动修复

2. **AI 代码分析**
   - 将 `AI analysis/` 文件夹发送给其他 AI 进行代码分析
   - 使用 `AI analysis/提示词模板.md` 中的提示词模板
   - 等待分析结果，获取大文件拆分建议

3. **开始大文件拆分**
   - 根据 AI 分析结果，开始实施大文件拆分
   - 确保拆分后的代码结构清晰、可维护

### 7.2 中期计划（按需）

1. **实施日志国际化优化**
   - 根据 `docs/code_refactoring_analysis.md` 中的方案
   - 选择合适的方法（键值化、包装器、混合方案）
   - 逐步实施，确保不影响现有功能

2. **继续 P1 任务**
   - P1-2：URL 列表模式增强（如需要）
   - P1-3：其他增强功能

---

## 8. 快速上手检查清单

### 8.1 新会话开始时

- [ ] 阅读 `docs/v2_final_plan.md`（行为规范，最高优先级）
- [ ] 阅读 `docs/ide_任务表.md`（了解任务清单和顺序）
- [ ] 阅读 `docs/ide_修复任务表_AI层与流水线.md`（了解 R 系列任务状态）
- [ ] 阅读 `docs/dev_log.md`（了解最近的工作进展，特别是 2025-12-15 的日志）
- [ ] 阅读 `docs/code_refactoring_analysis.md`（了解代码重构分析和下一步计划）

### 8.2 开始新任务前

- [ ] 确认任务在 `docs/ide_任务表.md` 或 `docs/ide_修复任务表_AI层与流水线.md` 中的位置和依赖
- [ ] 检查是否有相关的测试任务（`docs/ide_测试任务表.md`）
- [ ] 查看 `docs/dev_log.md` 中是否有相关历史记录
- [ ] 确认代码修改是否符合 `docs/v2_final_plan.md` 的行为规范

### 8.3 完成任务后

- [ ] 更新 `docs/ide_任务表.md` 或 `docs/ide_修复任务表_AI层与流水线.md` 中的任务状态
- [ ] 更新 `docs/dev_log.md` 记录工作内容
- [ ] 如有测试任务，更新 `docs/ide_测试任务表.md` 的测试状态
- [ ] 检查代码是否符合规范（`docs/ide_integration.md`）

---

## 9. 关键技术点

### 9.1 分阶段流水线架构（R3-1）

**架构说明**：
- 将单一 pipeline 拆分为多个阶段：DETECT → DOWNLOAD → TRANSLATE → SUMMARIZE → OUTPUT
- 使用 `StageQueue` 和 `ThreadPoolExecutor` 管理各阶段的并发
- 支持不同阶段使用不同的并发数（I/O 密集 vs AI 计算密集）
- 保持与现有规范完全一致的行为

**相关文件**：
- `core/staged_pipeline.py` - 分阶段流水线实现
- `core/pipeline.py` - 集成分阶段流水线（`use_staged_pipeline=True`）

### 9.2 AI Profile 配置管理（R3-2）

**功能说明**：
- 通过 `ai_profiles.json` 配置文件定义任务到模型/供应商的映射
- 支持多个 Profile（如 `subtitle_translate_default`、`subtitle_summarize_fast`）
- 允许在不改代码的前提下调整 AI 策略
- UI 中显示当前使用的 AI Profile

**相关文件**：
- `core/ai_profile_manager.py` - AI Profile 管理器
- `config/ai_profiles.json.example` - 配置示例
- `docs/ai_profile_design.md` - 设计文档
- `docs/ai_profile_usage.md` - 使用指南

### 9.3 本地模型预热（R3-3）

**功能说明**：
- 针对本地 LLM（通过 `OpenAICompatibleClient` 的 `base_url` 配置，如 `http://localhost:11434/v1`）
- 在初始化时进行异步预热（轻量调用）
- 避免初次调用冷启动延迟
- 与 AI 并发限流（`Semaphore`）协同工作

**相关文件**：
- `core/ai_providers.py` - `OpenAICompatibleClient._warmup()` 方法
- `docs/local_model_warmup.md` - 文档说明

### 9.4 AI 供应商健康检查（R3-4）

**功能说明**：
- CLI 命令：`python cli.py ai-smoke-test`
- 遍历所有启用的 AI 配置（包括 AI Profile）
- 发送最小请求验证 API Key、网络连接、代理设置
- 生成健康报告（健康/不健康/已禁用/未配置）

**相关文件**：
- `cli/ai_smoke_test.py` - 健康检查实现
- `docs/ai_smoke_test_guide.md` - 使用指南

### 9.5 日志框时间戳和代理状态

**功能说明**：
- 日志框显示时间戳（格式：`[2025-12-15 23:51:23.890]`）
- 状态栏显示代理状态（未配置/已配置 (X个健康)/已配置 (X健康/Y不健康)/直连 (X个不健康)）
- 与控制台日志格式保持一致

**相关文件**：
- `ui/components/log_panel.py` - 日志面板（时间戳和代理状态）
- `ui/main_window.py` - 主窗口（代理状态更新逻辑）

---

## 10. 重要配置和路径

### 10.1 配置文件位置

| 配置类型 | 文件路径 | 说明 |
|---------|---------|------|
| 应用配置 | `config.json`（用户数据目录） | 主配置文件，包含所有设置 |
| AI Profile 配置 | `ai_profiles.json`（用户数据目录） | **AI Profile 配置**（R3-2） |
| 语言配置 | `config.json` 中的 `language_config` | 语言相关配置 |
| AI 配置 | `config.json` 中的 `ai_config` | AI 供应商和模型配置 |
| Cookie | `cookies.txt`（用户数据目录） | YouTube Cookie 文件（Netscape 格式） |
| 代理列表 | `config.json` 中的 `proxies` | 代理服务器列表 |

### 10.2 输出目录结构

```
out/
├── <channel_name> [<channel_id>]/
│   ├── <video_id> <title>/
│   │   ├── original.<lang>.srt          # 原始字幕
│   │   ├── translated.<lang>.srt        # 翻译字幕
│   │   ├── bilingual.<source>-<target>.srt  # 双语字幕
│   │   ├── summary.<lang>.txt           # 摘要
│   │   └── metadata.json                # 元数据
├── archives/                            # 增量管理文件
│   └── <channel_id>.txt
├── failed_urls.txt                      # 失败 URL 列表
├── failed_detail.log                    # 失败详情日志
└── failed_records.json                  # 失败记录（JSON 格式）
```

### 10.3 临时目录

- **路径**：`temp/`（项目根目录）
- **清理策略**：每次任务结束后自动清理
- **保留策略**：失败时根据配置决定是否保留（`keep_temp_on_error`）

---

## 11. 常见问题和解决方案

### 11.1 已解决的问题

| 问题 | 解决方案 | 相关文件 |
|------|---------|---------|
| 日志框缺少时间戳 | 添加时间戳生成和显示 | `ui/components/log_panel.py` |
| 状态栏缺少代理状态 | 添加代理状态计算和显示 | `ui/components/log_panel.py`, `ui/main_window.py` |
| Git 提交信息乱码 | 创建修复脚本和文档 | `fix_commits_gitbash.sh`, `docs/fix_commit_encoding.md` |

### 11.2 已知限制

| 限制 | 说明 | 影响 |
|------|------|------|
| customtkinter CTkComboBox | 无法在下拉列表内部添加自定义控件 | 无法实现内部翻页按钮 |
| PowerShell 编码限制 | 无法在 PowerShell 中自动修复 Git 提交信息 | 需要在 Git Bash 环境中执行修复脚本 |

---

## 12. 开发环境设置

### 12.1 必需依赖

```bash
pip install -r requirements.txt
```

**主要依赖**：
- `customtkinter`：GUI 框架
- `yt-dlp`：视频信息获取和字幕下载
- `openai`：OpenAI API 客户端
- `anthropic`：Anthropic API 客户端
- `google-generativeai`：Google Gemini API 客户端
- `deep-translator`：Google Translate 免费翻译

### 12.2 环境变量（可选）

- `OPENAI_API_KEY`：OpenAI API Key
- `ANTHROPIC_API_KEY`：Anthropic API Key
- `GOOGLE_API_KEY`：Google Gemini API Key

### 12.3 运行方式

**CLI 模式**：
```bash
# 频道模式
python cli.py channel --url "https://www.youtube.com/@channel_name"

# URL 列表模式
python cli.py urls --file test_urls.txt

# Dry Run 模式（仅检测，不下载）
python cli.py channel --url "..." --dry-run

# 强制重跑（忽略历史记录）
python cli.py channel --url "..." --force

# AI 供应商健康检查（R3-4）
python cli.py ai-smoke-test
```

**GUI 模式**：
```bash
python main.py
```

### 12.4 用户数据目录

**Windows**：
- `%APPDATA%\yt-subtitle-v2\`
- 包含：`config.json`、`ai_profiles.json`、`cookies.txt`、`archives/` 目录

**Linux/Mac**：
- `~/.config/yt-subtitle-v2/`
- 包含：`config.json`、`ai_profiles.json`、`cookies.txt`、`archives/` 目录

---

## 13. 重要提醒

1. **行为规范优先**：`docs/v2_final_plan.md` 是最高优先级，任何实现必须符合此文档
2. **任务顺序**：严格按照 `docs/ide_任务表.md` 或 `docs/ide_修复任务表_AI层与流水线.md` 中的顺序执行
3. **代码规范**：遵循 `docs/ide_integration.md` 中的 IDE 行为约束
4. **测试优先**：完成功能后必须进行测试，更新测试状态
5. **日志记录**：重要工作完成后更新 `docs/dev_log.md`
6. **R3 任务已完成**：所有 R0、R1、R2、R3 任务都已完成，当前处于代码重构准备阶段

---

**文档结束**

> **提示**：新会话开始时，建议先阅读第 8 节的"快速上手检查清单"，然后根据具体任务查阅相关章节。重点关注今天（2025-12-15）完成的工作和下一步计划。

