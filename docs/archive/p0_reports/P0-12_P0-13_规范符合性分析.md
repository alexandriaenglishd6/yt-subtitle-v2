# P0-12 和 P0-13 规范符合性分析

## 检查依据

- `docs/ai_design.md` - AI 调用设计规范
- `docs/README_for_IDE.md` - IDE 行为约束

## 当前实现状态

### ✅ 已符合的部分

1. **抽象接口设计**
   - ✅ 使用了抽象基类 `AIProvider`（虽然命名不同，但功能类似）
   - ✅ 使用工厂模式 `get_provider()` 创建实例
   - ✅ 支持动态注册新提供商

2. **配置驱动**
   - ✅ 使用 `AIConfig` 从配置读取 provider/model
   - ✅ 支持通过配置切换提供商

3. **业务模块隔离**
   - ✅ `SubtitleTranslator` 和 `Summarizer` 通过统一接口调用 AI
   - ✅ 不直接依赖具体 SDK

### ❌ 不符合的部分

1. **接口命名和结构**
   - ❌ 当前使用 `AIProvider.call(system_prompt, user_prompt)` 
   - ❌ 规范要求 `LLMClient.generate(prompt, system=..., max_tokens=..., temperature=..., stop=...)`
   - ❌ 缺少 `LLMResult` 和 `LLMUsage` 结构化返回

2. **错误处理**
   - ❌ 当前返回 `None` 表示失败，没有统一异常类型
   - ❌ 规范要求使用 `LLMException` 和 `LLMErrorType` 统一错误分类

3. **AIConfig 不完整**
   - ❌ 缺少 `base_url`（自定义 API 网关）
   - ❌ 缺少 `timeout_seconds`（超时配置）
   - ❌ 缺少 `max_retries`（重试次数）
   - ❌ 缺少 `api_keys` 字典（支持多 provider 的 key）
   - ❌ 当前使用单个 `api_key_env`，不符合规范

4. **业务模块使用方式**
   - ❌ 当前在 `SubtitleTranslator` 和 `Summarizer` 内部调用 `get_provider()`
   - ❌ 规范要求接收 `LLMClient` 实例作为参数

5. **缺少重试逻辑**
   - ❌ 没有实现 `max_retries` 重试机制
   - ❌ 没有错误类型分类和重试策略

## 需要重构的内容

### 优先级 P0（必须修复）

1. **创建 `LLMClient` 抽象接口**
   - 定义 `LLMClient` Protocol
   - 定义 `LLMResult` 和 `LLMUsage` 数据类
   - 定义 `LLMException` 和 `LLMErrorType`

2. **扩展 `AIConfig`**
   - 添加 `base_url`, `timeout_seconds`, `max_retries`
   - 将 `api_key_env` 改为 `api_keys` 字典
   - 支持 `"env:OPENAI_API_KEY"` 格式

3. **重构 Provider 实现**
   - 将 `AIProvider` 改为实现 `LLMClient` Protocol
   - 实现错误映射（供应商异常 → `LLMException`）
   - 实现重试逻辑

4. **重构业务模块**
   - `SubtitleTranslator` 和 `Summarizer` 接收 `LLMClient` 实例
   - 移除内部 `get_provider()` 调用
   - 使用 `LLMResult` 处理返回结果

### 优先级 P1（可以后续优化）

1. **Usage 统计**
   - 从供应商响应中提取 tokens 统计
   - 填充 `LLMUsage` 字段

2. **策略层**
   - 实现简单的 `AIStrategy` 类
   - 为未来扩展预留接口

## 重构建议

建议创建一个新的任务 **P0-12-fix** 和 **P0-13-fix**，专门用于重构以符合 `ai_design.md` 规范。

这样可以：
- 保持当前功能可用（向后兼容）
- 逐步迁移到新架构
- 不影响其他任务的进度

