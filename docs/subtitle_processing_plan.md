# 字幕清洗与预处理方案

> 本文档从 `v2_high_concurrency_plan.md` 阶段 3 拆分出来，详细描述字幕处理流程。

---

## 问题描述

| 问题 | 描述 | 影响 |
|------|------|------|
| **截断不当** | 句子在中间被切断 | 阅读不流畅 |
| **无意义字符** | `[音乐]`、`♪`、`[笑声]` | 干扰摘要 |
| **短句过多** | 2-3 个词一段 | 碎片化 |

---

## 处理流水线

```
┌─────────────────────────────────────────────────────────────────┐
│                    字幕处理流水线                                │
├─────────────────────────────────────────────────────────────────┤
│  阶段 1：规则清洗（必做，免费）                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  ① 无意义字符清洗 → ② 短句智能合并                         │   │
│  └──────────────────────────────────────────────────────────┘   │
│                          ↓                                       │
│  阶段 2：智能分段（二选一）                                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  if 文本短 (<5000字符) 或 用户选择 "always":              │   │
│  │      → AI 重新整理字幕（效果最好，使用通用 AI）            │   │
│  │  else:                                                    │   │
│  │      → NLP 规则分段（效果中等，免费）                      │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 配置选项

```json
{
  "subtitle_processing": {
    "clean_noise": true,
    "merge_short_segments": true,
    "ai_restructure": "auto"  // "off" | "auto" | "always"
  }
}
```

---

## 输出格式选项

| 格式 | 处理方式 | 输出内容 | 适合场景 |
|------|----------|----------|----------|
| `.srt` | 保留原始 | 带时间轴的字幕 | 视频播放器 |
| `.txt` | 仅去时间轴 | 原始分段纯文本 | 导入其他工具 |
| `.md` | 智能处理 | 清洗+分段+格式化 | 阅读、笔记软件 |

---

## 处理流程

```
SRT 流程: 下载 → 输出（保留时间轴）
TXT 流程: 下载 → 去时间轴 → 输出（原始分段）
MD  流程: 下载 → 清洗 → 合并 → 智能分段 → 格式化 → 输出
```

---

## MD 输出示例

```markdown
# 视频标题

这是第一段内容，讲述了主要观点。经过智能分段后更加流畅。

这是第二段内容，详细展开了讨论，保持了语义完整性。

---
*生成时间: 2025-12-24*
```

### 配置示例

```json
{
  "subtitle_format": "srt",      // srt | txt | md | all
  "txt_processing": "raw",       // raw（仅去时间轴）
  "md_processing": "smart"       // smart（清洗+分段，默认）
}
```

---

## NotebookLM 优化输出模式（可选）

> **目标**：输出适合 NotebookLM 解析的格式，便于构建个人知识库。

### NotebookLM 偏好

| 喜欢 | 不喜欢 |
|------|--------|
| ✅ 结构化 Markdown | ❌ 纯文本无结构 |
| ✅ 标题清晰 | ❌ 时间轴/时间戳 |
| ✅ 分段落 | ❌ 碎片化短句 |
| ✅ 元数据头 | ❌ 噪音字符 |

### 输出格式

```markdown
---
title: 视频标题
channel: 频道名
date: 2025-01-01
url: https://youtube.com/watch?v=xxx
playlist: 播放列表名（如有）
---

# 视频标题

## 摘要

这个视频主要讲了...

## 完整内容

第一段内容...

第二段内容...
```

### 配置

```json
{
  "output_mode": "notebooklm",   // standard | notebooklm
  "include_metadata": true,      // 添加元数据头
  "combine_subtitle_summary": true  // 合并字幕+摘要为单文件
}
```

### 好处

| 特性 | 效果 |
|------|------|
| 结构化 MD | NotebookLM 更易解析 |
| 元数据头 | 便于检索、分类 |
| 单文件输出 | 减少上传步骤 |
| 智能分段 | 减少碎片化 |

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [v2_high_concurrency_plan.md](./v2_high_concurrency_plan.md) | v2.0 总体规划 |
| [auxiliary_tools_plan.md](./auxiliary_tools_plan.md) | 独立辅助工具（文件合并器等） |
